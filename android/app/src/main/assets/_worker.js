var It=Object.defineProperty;var Be=e=>{throw TypeError(e)};var Ft=(e,t,r)=>t in e?It(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var m=(e,t,r)=>Ft(e,typeof t!="symbol"?t+"":t,r),De=(e,t,r)=>t.has(e)||Be("Cannot "+r);var d=(e,t,r)=>(De(e,t,"read from private field"),r?r.call(e):t.get(e)),v=(e,t,r)=>t.has(e)?Be("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),g=(e,t,r,s)=>(De(e,t,"write to private field"),s?s.call(e,r):t.set(e,r),r),S=(e,t,r)=>(De(e,t,"access private method"),r);var Ke=(e,t,r,s)=>({set _(n){g(e,t,n,r)},get _(){return d(e,t,s)}});var We=(e,t,r)=>(s,n)=>{let o=-1;return a(0);async function a(l){if(l<=o)throw new Error("next() called multiple times");o=l;let i,c=!1,u;if(e[l]?(u=e[l][0][0],s.req.routeIndex=l):u=l===e.length&&n||void 0,u)try{i=await u(s,()=>a(l+1))}catch(f){if(f instanceof Error&&t)s.error=f,i=await t(f,s),c=!0;else throw f}else s.finalized===!1&&r&&(i=await r(s));return i&&(s.finalized===!1||c)&&(s.res=i),s}},Jt=Symbol(),Lt=async(e,t=Object.create(null))=>{const{all:r=!1,dot:s=!1}=t,o=(e instanceof pt?e.raw.headers:e.headers).get("Content-Type");return o!=null&&o.startsWith("multipart/form-data")||o!=null&&o.startsWith("application/x-www-form-urlencoded")?kt(e,{all:r,dot:s}):{}};async function kt(e,t){const r=await e.formData();return r?Mt(r,t):{}}function Mt(e,t){const r=Object.create(null);return e.forEach((s,n)=>{t.all||n.endsWith("[]")?Ut(r,n,s):r[n]=s}),t.dot&&Object.entries(r).forEach(([s,n])=>{s.includes(".")&&(Bt(r,s,n),delete r[s])}),r}var Ut=(e,t,r)=>{e[t]!==void 0?Array.isArray(e[t])?e[t].push(r):e[t]=[e[t],r]:t.endsWith("[]")?e[t]=[r]:e[t]=r},Bt=(e,t,r)=>{let s=e;const n=t.split(".");n.forEach((o,a)=>{a===n.length-1?s[o]=r:((!s[o]||typeof s[o]!="object"||Array.isArray(s[o])||s[o]instanceof File)&&(s[o]=Object.create(null)),s=s[o])})},lt=e=>{const t=e.split("/");return t[0]===""&&t.shift(),t},Kt=e=>{const{groups:t,path:r}=Wt(e),s=lt(r);return Vt(s,t)},Wt=e=>{const t=[];return e=e.replace(/\{[^}]+\}/g,(r,s)=>{const n=`@${s}`;return t.push([n,r]),n}),{groups:t,path:e}},Vt=(e,t)=>{for(let r=t.length-1;r>=0;r--){const[s]=t[r];for(let n=e.length-1;n>=0;n--)if(e[n].includes(s)){e[n]=e[n].replace(s,t[r][1]);break}}return e},$e={},zt=(e,t)=>{if(e==="*")return"*";const r=e.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(r){const s=`${e}#${t}`;return $e[s]||(r[2]?$e[s]=t&&t[0]!==":"&&t[0]!=="*"?[s,r[1],new RegExp(`^${r[2]}(?=/${t})`)]:[e,r[1],new RegExp(`^${r[2]}$`)]:$e[s]=[e,r[1],!0]),$e[s]}return null},Me=(e,t)=>{try{return t(e)}catch{return e.replace(/(?:%[0-9A-Fa-f]{2})+/g,r=>{try{return t(r)}catch{return r}})}},Gt=e=>Me(e,decodeURI),ct=e=>{const t=e.url,r=t.indexOf("/",t.indexOf(":")+4);let s=r;for(;s<t.length;s++){const n=t.charCodeAt(s);if(n===37){const o=t.indexOf("?",s),a=t.slice(r,o===-1?void 0:o);return Gt(a.includes("%25")?a.replace(/%25/g,"%2525"):a)}else if(n===63)break}return t.slice(r,s)},Yt=e=>{const t=ct(e);return t.length>1&&t.at(-1)==="/"?t.slice(0,-1):t},oe=(e,t,...r)=>(r.length&&(t=oe(t,...r)),`${(e==null?void 0:e[0])==="/"?"":"/"}${e}${t==="/"?"":`${(e==null?void 0:e.at(-1))==="/"?"":"/"}${(t==null?void 0:t[0])==="/"?t.slice(1):t}`}`),dt=e=>{if(e.charCodeAt(e.length-1)!==63||!e.includes(":"))return null;const t=e.split("/"),r=[];let s="";return t.forEach(n=>{if(n!==""&&!/\:/.test(n))s+="/"+n;else if(/\:/.test(n))if(/\?/.test(n)){r.length===0&&s===""?r.push("/"):r.push(s);const o=n.replace("?","");s+="/"+o,r.push(s)}else s+="/"+n}),r.filter((n,o,a)=>a.indexOf(n)===o)},Ne=e=>/[%+]/.test(e)?(e.indexOf("+")!==-1&&(e=e.replace(/\+/g," ")),e.indexOf("%")!==-1?Me(e,ft):e):e,ut=(e,t,r)=>{let s;if(!r&&t&&!/[%+]/.test(t)){let a=e.indexOf("?",8);if(a===-1)return;for(e.startsWith(t,a+1)||(a=e.indexOf(`&${t}`,a+1));a!==-1;){const l=e.charCodeAt(a+t.length+1);if(l===61){const i=a+t.length+2,c=e.indexOf("&",i);return Ne(e.slice(i,c===-1?void 0:c))}else if(l==38||isNaN(l))return"";a=e.indexOf(`&${t}`,a+1)}if(s=/[%+]/.test(e),!s)return}const n={};s??(s=/[%+]/.test(e));let o=e.indexOf("?",8);for(;o!==-1;){const a=e.indexOf("&",o+1);let l=e.indexOf("=",o);l>a&&a!==-1&&(l=-1);let i=e.slice(o+1,l===-1?a===-1?void 0:a:l);if(s&&(i=Ne(i)),o=a,i==="")continue;let c;l===-1?c="":(c=e.slice(l+1,a===-1?void 0:a),s&&(c=Ne(c))),r?(n[i]&&Array.isArray(n[i])||(n[i]=[]),n[i].push(c)):n[i]??(n[i]=c)}return t?n[t]:n},Xt=ut,Qt=(e,t)=>ut(e,t,!0),ft=decodeURIComponent,Ve=e=>Me(e,ft),le,T,M,ht,_t,Je,K,Ze,pt=(Ze=class{constructor(e,t="/",r=[[]]){v(this,M);m(this,"raw");v(this,le);v(this,T);m(this,"routeIndex",0);m(this,"path");m(this,"bodyCache",{});v(this,K,e=>{const{bodyCache:t,raw:r}=this,s=t[e];if(s)return s;const n=Object.keys(t)[0];return n?t[n].then(o=>(n==="json"&&(o=JSON.stringify(o)),new Response(o)[e]())):t[e]=r[e]()});this.raw=e,this.path=t,g(this,T,r),g(this,le,{})}param(e){return e?S(this,M,ht).call(this,e):S(this,M,_t).call(this)}query(e){return Xt(this.url,e)}queries(e){return Qt(this.url,e)}header(e){if(e)return this.raw.headers.get(e)??void 0;const t={};return this.raw.headers.forEach((r,s)=>{t[s]=r}),t}async parseBody(e){var t;return(t=this.bodyCache).parsedBody??(t.parsedBody=await Lt(this,e))}json(){return d(this,K).call(this,"text").then(e=>JSON.parse(e))}text(){return d(this,K).call(this,"text")}arrayBuffer(){return d(this,K).call(this,"arrayBuffer")}blob(){return d(this,K).call(this,"blob")}formData(){return d(this,K).call(this,"formData")}addValidatedData(e,t){d(this,le)[e]=t}valid(e){return d(this,le)[e]}get url(){return this.raw.url}get method(){return this.raw.method}get[Jt](){return d(this,T)}get matchedRoutes(){return d(this,T)[0].map(([[,e]])=>e)}get routePath(){return d(this,T)[0].map(([[,e]])=>e)[this.routeIndex].path}},le=new WeakMap,T=new WeakMap,M=new WeakSet,ht=function(e){const t=d(this,T)[0][this.routeIndex][1][e],r=S(this,M,Je).call(this,t);return r&&/\%/.test(r)?Ve(r):r},_t=function(){const e={},t=Object.keys(d(this,T)[0][this.routeIndex][1]);for(const r of t){const s=S(this,M,Je).call(this,d(this,T)[0][this.routeIndex][1][r]);s!==void 0&&(e[r]=/\%/.test(s)?Ve(s):s)}return e},Je=function(e){return d(this,T)[1]?d(this,T)[1][e]:e},K=new WeakMap,Ze),Zt={Stringify:1},gt=async(e,t,r,s,n)=>{typeof e=="object"&&!(e instanceof String)&&(e instanceof Promise||(e=e.toString()),e instanceof Promise&&(e=await e));const o=e.callbacks;return o!=null&&o.length?(n?n[0]+=e:n=[e],Promise.all(o.map(l=>l({phase:t,buffer:n,context:s}))).then(l=>Promise.all(l.filter(Boolean).map(i=>gt(i,t,!1,s,n))).then(()=>n[0]))):Promise.resolve(e)},er="text/plain; charset=UTF-8",He=(e,t)=>({"Content-Type":e,...t}),ye,we,F,ce,J,O,ve,de,ue,Z,je,be,W,ae,et,tr=(et=class{constructor(e,t){v(this,W);v(this,ye);v(this,we);m(this,"env",{});v(this,F);m(this,"finalized",!1);m(this,"error");v(this,ce);v(this,J);v(this,O);v(this,ve);v(this,de);v(this,ue);v(this,Z);v(this,je);v(this,be);m(this,"render",(...e)=>(d(this,de)??g(this,de,t=>this.html(t)),d(this,de).call(this,...e)));m(this,"setLayout",e=>g(this,ve,e));m(this,"getLayout",()=>d(this,ve));m(this,"setRenderer",e=>{g(this,de,e)});m(this,"header",(e,t,r)=>{this.finalized&&g(this,O,new Response(d(this,O).body,d(this,O)));const s=d(this,O)?d(this,O).headers:d(this,Z)??g(this,Z,new Headers);t===void 0?s.delete(e):r!=null&&r.append?s.append(e,t):s.set(e,t)});m(this,"status",e=>{g(this,ce,e)});m(this,"set",(e,t)=>{d(this,F)??g(this,F,new Map),d(this,F).set(e,t)});m(this,"get",e=>d(this,F)?d(this,F).get(e):void 0);m(this,"newResponse",(...e)=>S(this,W,ae).call(this,...e));m(this,"body",(e,t,r)=>S(this,W,ae).call(this,e,t,r));m(this,"text",(e,t,r)=>!d(this,Z)&&!d(this,ce)&&!t&&!r&&!this.finalized?new Response(e):S(this,W,ae).call(this,e,t,He(er,r)));m(this,"json",(e,t,r)=>S(this,W,ae).call(this,JSON.stringify(e),t,He("application/json",r)));m(this,"html",(e,t,r)=>{const s=n=>S(this,W,ae).call(this,n,t,He("text/html; charset=UTF-8",r));return typeof e=="object"?gt(e,Zt.Stringify,!1,{}).then(s):s(e)});m(this,"redirect",(e,t)=>{const r=String(e);return this.header("Location",/[^\x00-\xFF]/.test(r)?encodeURI(r):r),this.newResponse(null,t??302)});m(this,"notFound",()=>(d(this,ue)??g(this,ue,()=>new Response),d(this,ue).call(this,this)));g(this,ye,e),t&&(g(this,J,t.executionCtx),this.env=t.env,g(this,ue,t.notFoundHandler),g(this,be,t.path),g(this,je,t.matchResult))}get req(){return d(this,we)??g(this,we,new pt(d(this,ye),d(this,be),d(this,je))),d(this,we)}get event(){if(d(this,J)&&"respondWith"in d(this,J))return d(this,J);throw Error("This context has no FetchEvent")}get executionCtx(){if(d(this,J))return d(this,J);throw Error("This context has no ExecutionContext")}get res(){return d(this,O)||g(this,O,new Response(null,{headers:d(this,Z)??g(this,Z,new Headers)}))}set res(e){if(d(this,O)&&e){e=new Response(e.body,e);for(const[t,r]of d(this,O).headers.entries())if(t!=="content-type")if(t==="set-cookie"){const s=d(this,O).headers.getSetCookie();e.headers.delete("set-cookie");for(const n of s)e.headers.append("set-cookie",n)}else e.headers.set(t,r)}g(this,O,e),this.finalized=!0}get var(){return d(this,F)?Object.fromEntries(d(this,F)):{}}},ye=new WeakMap,we=new WeakMap,F=new WeakMap,ce=new WeakMap,J=new WeakMap,O=new WeakMap,ve=new WeakMap,de=new WeakMap,ue=new WeakMap,Z=new WeakMap,je=new WeakMap,be=new WeakMap,W=new WeakSet,ae=function(e,t,r){const s=d(this,O)?new Headers(d(this,O).headers):d(this,Z)??new Headers;if(typeof t=="object"&&"headers"in t){const o=t.headers instanceof Headers?t.headers:new Headers(t.headers);for(const[a,l]of o)a.toLowerCase()==="set-cookie"?s.append(a,l):s.set(a,l)}if(r)for(const[o,a]of Object.entries(r))if(typeof a=="string")s.set(o,a);else{s.delete(o);for(const l of a)s.append(o,l)}const n=typeof t=="number"?t:(t==null?void 0:t.status)??d(this,ce);return new Response(e,{status:n,headers:s})},et),R="ALL",rr="all",sr=["get","post","put","delete","options","patch"],mt="Can not add a route since the matcher is already built.",yt=class extends Error{},nr="__COMPOSED_HANDLER",or=e=>e.text("404 Not Found",404),ze=(e,t)=>{if("getResponse"in e){const r=e.getResponse();return t.newResponse(r.body,r)}return console.error(e),t.text("Internal Server Error",500)},C,x,vt,q,X,Re,xe,tt,wt=(tt=class{constructor(t={}){v(this,x);m(this,"get");m(this,"post");m(this,"put");m(this,"delete");m(this,"options");m(this,"patch");m(this,"all");m(this,"on");m(this,"use");m(this,"router");m(this,"getPath");m(this,"_basePath","/");v(this,C,"/");m(this,"routes",[]);v(this,q,or);m(this,"errorHandler",ze);m(this,"onError",t=>(this.errorHandler=t,this));m(this,"notFound",t=>(g(this,q,t),this));m(this,"fetch",(t,...r)=>S(this,x,xe).call(this,t,r[1],r[0],t.method));m(this,"request",(t,r,s,n)=>t instanceof Request?this.fetch(r?new Request(t,r):t,s,n):(t=t.toString(),this.fetch(new Request(/^https?:\/\//.test(t)?t:`http://localhost${oe("/",t)}`,r),s,n)));m(this,"fire",()=>{addEventListener("fetch",t=>{t.respondWith(S(this,x,xe).call(this,t.request,t,void 0,t.request.method))})});[...sr,rr].forEach(o=>{this[o]=(a,...l)=>(typeof a=="string"?g(this,C,a):S(this,x,X).call(this,o,d(this,C),a),l.forEach(i=>{S(this,x,X).call(this,o,d(this,C),i)}),this)}),this.on=(o,a,...l)=>{for(const i of[a].flat()){g(this,C,i);for(const c of[o].flat())l.map(u=>{S(this,x,X).call(this,c.toUpperCase(),d(this,C),u)})}return this},this.use=(o,...a)=>(typeof o=="string"?g(this,C,o):(g(this,C,"*"),a.unshift(o)),a.forEach(l=>{S(this,x,X).call(this,R,d(this,C),l)}),this);const{strict:s,...n}=t;Object.assign(this,n),this.getPath=s??!0?t.getPath??ct:Yt}route(t,r){const s=this.basePath(t);return r.routes.map(n=>{var a;let o;r.errorHandler===ze?o=n.handler:(o=async(l,i)=>(await We([],r.errorHandler)(l,()=>n.handler(l,i))).res,o[nr]=n.handler),S(a=s,x,X).call(a,n.method,n.path,o)}),this}basePath(t){const r=S(this,x,vt).call(this);return r._basePath=oe(this._basePath,t),r}mount(t,r,s){let n,o;s&&(typeof s=="function"?o=s:(o=s.optionHandler,s.replaceRequest===!1?n=i=>i:n=s.replaceRequest));const a=o?i=>{const c=o(i);return Array.isArray(c)?c:[c]}:i=>{let c;try{c=i.executionCtx}catch{}return[i.env,c]};n||(n=(()=>{const i=oe(this._basePath,t),c=i==="/"?0:i.length;return u=>{const f=new URL(u.url);return f.pathname=f.pathname.slice(c)||"/",new Request(f,u)}})());const l=async(i,c)=>{const u=await r(n(i.req.raw),...a(i));if(u)return u;await c()};return S(this,x,X).call(this,R,oe(t,"*"),l),this}},C=new WeakMap,x=new WeakSet,vt=function(){const t=new wt({router:this.router,getPath:this.getPath});return t.errorHandler=this.errorHandler,g(t,q,d(this,q)),t.routes=this.routes,t},q=new WeakMap,X=function(t,r,s){t=t.toUpperCase(),r=oe(this._basePath,r);const n={basePath:this._basePath,path:r,method:t,handler:s};this.router.add(t,r,[s,n]),this.routes.push(n)},Re=function(t,r){if(t instanceof Error)return this.errorHandler(t,r);throw t},xe=function(t,r,s,n){if(n==="HEAD")return(async()=>new Response(null,await S(this,x,xe).call(this,t,r,s,"GET")))();const o=this.getPath(t,{env:s}),a=this.router.match(n,o),l=new tr(t,{path:o,matchResult:a,env:s,executionCtx:r,notFoundHandler:d(this,q)});if(a[0].length===1){let c;try{c=a[0][0][0][0](l,async()=>{l.res=await d(this,q).call(this,l)})}catch(u){return S(this,x,Re).call(this,u,l)}return c instanceof Promise?c.then(u=>u||(l.finalized?l.res:d(this,q).call(this,l))).catch(u=>S(this,x,Re).call(this,u,l)):c??d(this,q).call(this,l)}const i=We(a[0],this.errorHandler,d(this,q));return(async()=>{try{const c=await i(l);if(!c.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return c.res}catch(c){return S(this,x,Re).call(this,c,l)}})()},tt),jt=[];function ar(e,t){const r=this.buildAllMatchers(),s=(n,o)=>{const a=r[n]||r[R],l=a[2][o];if(l)return l;const i=o.match(a[0]);if(!i)return[[],jt];const c=i.indexOf("",1);return[a[1][c],i]};return this.match=s,s(e,t)}var Pe="[^/]+",_e=".*",ge="(?:|/.*)",ie=Symbol(),ir=new Set(".\\+*[^]$()");function lr(e,t){return e.length===1?t.length===1?e<t?-1:1:-1:t.length===1||e===_e||e===ge?1:t===_e||t===ge?-1:e===Pe?1:t===Pe?-1:e.length===t.length?e<t?-1:1:t.length-e.length}var ee,te,D,rt,Le=(rt=class{constructor(){v(this,ee);v(this,te);v(this,D,Object.create(null))}insert(t,r,s,n,o){if(t.length===0){if(d(this,ee)!==void 0)throw ie;if(o)return;g(this,ee,r);return}const[a,...l]=t,i=a==="*"?l.length===0?["","",_e]:["","",Pe]:a==="/*"?["","",ge]:a.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);let c;if(i){const u=i[1];let f=i[2]||Pe;if(u&&i[2]&&(f===".*"||(f=f.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(f))))throw ie;if(c=d(this,D)[f],!c){if(Object.keys(d(this,D)).some(h=>h!==_e&&h!==ge))throw ie;if(o)return;c=d(this,D)[f]=new Le,u!==""&&g(c,te,n.varIndex++)}!o&&u!==""&&s.push([u,d(c,te)])}else if(c=d(this,D)[a],!c){if(Object.keys(d(this,D)).some(u=>u.length>1&&u!==_e&&u!==ge))throw ie;if(o)return;c=d(this,D)[a]=new Le}c.insert(l,r,s,n,o)}buildRegExpStr(){const r=Object.keys(d(this,D)).sort(lr).map(s=>{const n=d(this,D)[s];return(typeof d(n,te)=="number"?`(${s})@${d(n,te)}`:ir.has(s)?`\\${s}`:s)+n.buildRegExpStr()});return typeof d(this,ee)=="number"&&r.unshift(`#${d(this,ee)}`),r.length===0?"":r.length===1?r[0]:"(?:"+r.join("|")+")"}},ee=new WeakMap,te=new WeakMap,D=new WeakMap,rt),Oe,Se,st,cr=(st=class{constructor(){v(this,Oe,{varIndex:0});v(this,Se,new Le)}insert(e,t,r){const s=[],n=[];for(let a=0;;){let l=!1;if(e=e.replace(/\{[^}]+\}/g,i=>{const c=`@\\${a}`;return n[a]=[c,i],a++,l=!0,c}),!l)break}const o=e.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let a=n.length-1;a>=0;a--){const[l]=n[a];for(let i=o.length-1;i>=0;i--)if(o[i].indexOf(l)!==-1){o[i]=o[i].replace(l,n[a][1]);break}}return d(this,Se).insert(o,t,s,d(this,Oe),r),s}buildRegExp(){let e=d(this,Se).buildRegExpStr();if(e==="")return[/^$/,[],[]];let t=0;const r=[],s=[];return e=e.replace(/#(\d+)|@(\d+)|\.\*\$/g,(n,o,a)=>o!==void 0?(r[++t]=Number(o),"$()"):(a!==void 0&&(s[Number(a)]=++t),"")),[new RegExp(`^${e}`),r,s]}},Oe=new WeakMap,Se=new WeakMap,st),dr=[/^$/,[],Object.create(null)],Ae=Object.create(null);function bt(e){return Ae[e]??(Ae[e]=new RegExp(e==="*"?"":`^${e.replace(/\/\*$|([.\\+*[^\]$()])/g,(t,r)=>r?`\\${r}`:"(?:|/.*)")}$`))}function ur(){Ae=Object.create(null)}function fr(e){var c;const t=new cr,r=[];if(e.length===0)return dr;const s=e.map(u=>[!/\*|\/:/.test(u[0]),...u]).sort(([u,f],[h,j])=>u?1:h?-1:f.length-j.length),n=Object.create(null);for(let u=0,f=-1,h=s.length;u<h;u++){const[j,$,w]=s[u];j?n[$]=[w.map(([E])=>[E,Object.create(null)]),jt]:f++;let b;try{b=t.insert($,f,j)}catch(E){throw E===ie?new yt($):E}j||(r[f]=w.map(([E,H])=>{const U=Object.create(null);for(H-=1;H>=0;H--){const[N,Ce]=b[H];U[N]=Ce}return[E,U]}))}const[o,a,l]=t.buildRegExp();for(let u=0,f=r.length;u<f;u++)for(let h=0,j=r[u].length;h<j;h++){const $=(c=r[u][h])==null?void 0:c[1];if(!$)continue;const w=Object.keys($);for(let b=0,E=w.length;b<E;b++)$[w[b]]=l[$[w[b]]]}const i=[];for(const u in a)i[u]=r[a[u]];return[o,i,n]}function ne(e,t){if(e){for(const r of Object.keys(e).sort((s,n)=>n.length-s.length))if(bt(r).test(t))return[...e[r]]}}var V,z,Te,St,nt,pr=(nt=class{constructor(){v(this,Te);m(this,"name","RegExpRouter");v(this,V);v(this,z);m(this,"match",ar);g(this,V,{[R]:Object.create(null)}),g(this,z,{[R]:Object.create(null)})}add(e,t,r){var l;const s=d(this,V),n=d(this,z);if(!s||!n)throw new Error(mt);s[e]||[s,n].forEach(i=>{i[e]=Object.create(null),Object.keys(i[R]).forEach(c=>{i[e][c]=[...i[R][c]]})}),t==="/*"&&(t="*");const o=(t.match(/\/:/g)||[]).length;if(/\*$/.test(t)){const i=bt(t);e===R?Object.keys(s).forEach(c=>{var u;(u=s[c])[t]||(u[t]=ne(s[c],t)||ne(s[R],t)||[])}):(l=s[e])[t]||(l[t]=ne(s[e],t)||ne(s[R],t)||[]),Object.keys(s).forEach(c=>{(e===R||e===c)&&Object.keys(s[c]).forEach(u=>{i.test(u)&&s[c][u].push([r,o])})}),Object.keys(n).forEach(c=>{(e===R||e===c)&&Object.keys(n[c]).forEach(u=>i.test(u)&&n[c][u].push([r,o]))});return}const a=dt(t)||[t];for(let i=0,c=a.length;i<c;i++){const u=a[i];Object.keys(n).forEach(f=>{var h;(e===R||e===f)&&((h=n[f])[u]||(h[u]=[...ne(s[f],u)||ne(s[R],u)||[]]),n[f][u].push([r,o-c+i+1]))})}}buildAllMatchers(){const e=Object.create(null);return Object.keys(d(this,z)).concat(Object.keys(d(this,V))).forEach(t=>{e[t]||(e[t]=S(this,Te,St).call(this,t))}),g(this,V,g(this,z,void 0)),ur(),e}},V=new WeakMap,z=new WeakMap,Te=new WeakSet,St=function(e){const t=[];let r=e===R;return[d(this,V),d(this,z)].forEach(s=>{const n=s[e]?Object.keys(s[e]).map(o=>[o,s[e][o]]):[];n.length!==0?(r||(r=!0),t.push(...n)):e!==R&&t.push(...Object.keys(s[R]).map(o=>[o,s[R][o]]))}),r?fr(t):null},nt),G,L,ot,hr=(ot=class{constructor(e){m(this,"name","SmartRouter");v(this,G,[]);v(this,L,[]);g(this,G,e.routers)}add(e,t,r){if(!d(this,L))throw new Error(mt);d(this,L).push([e,t,r])}match(e,t){if(!d(this,L))throw new Error("Fatal error");const r=d(this,G),s=d(this,L),n=r.length;let o=0,a;for(;o<n;o++){const l=r[o];try{for(let i=0,c=s.length;i<c;i++)l.add(...s[i]);a=l.match(e,t)}catch(i){if(i instanceof yt)continue;throw i}this.match=l.match.bind(l),g(this,G,[l]),g(this,L,void 0);break}if(o===n)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,a}get activeRouter(){if(d(this,L)||d(this,G).length!==1)throw new Error("No active router has been determined yet.");return d(this,G)[0]}},G=new WeakMap,L=new WeakMap,ot),he=Object.create(null),Y,P,re,fe,A,k,Q,at,Et=(at=class{constructor(e,t,r){v(this,k);v(this,Y);v(this,P);v(this,re);v(this,fe,0);v(this,A,he);if(g(this,P,r||Object.create(null)),g(this,Y,[]),e&&t){const s=Object.create(null);s[e]={handler:t,possibleKeys:[],score:0},g(this,Y,[s])}g(this,re,[])}insert(e,t,r){g(this,fe,++Ke(this,fe)._);let s=this;const n=Kt(t),o=[];for(let a=0,l=n.length;a<l;a++){const i=n[a],c=n[a+1],u=zt(i,c),f=Array.isArray(u)?u[0]:i;if(f in d(s,P)){s=d(s,P)[f],u&&o.push(u[1]);continue}d(s,P)[f]=new Et,u&&(d(s,re).push(u),o.push(u[1])),s=d(s,P)[f]}return d(s,Y).push({[e]:{handler:r,possibleKeys:o.filter((a,l,i)=>i.indexOf(a)===l),score:d(this,fe)}}),s}search(e,t){var l;const r=[];g(this,A,he);let n=[this];const o=lt(t),a=[];for(let i=0,c=o.length;i<c;i++){const u=o[i],f=i===c-1,h=[];for(let j=0,$=n.length;j<$;j++){const w=n[j],b=d(w,P)[u];b&&(g(b,A,d(w,A)),f?(d(b,P)["*"]&&r.push(...S(this,k,Q).call(this,d(b,P)["*"],e,d(w,A))),r.push(...S(this,k,Q).call(this,b,e,d(w,A)))):h.push(b));for(let E=0,H=d(w,re).length;E<H;E++){const U=d(w,re)[E],N=d(w,A)===he?{}:{...d(w,A)};if(U==="*"){const B=d(w,P)["*"];B&&(r.push(...S(this,k,Q).call(this,B,e,d(w,A))),g(B,A,N),h.push(B));continue}const[Ce,Ue,pe]=U;if(!u&&!(pe instanceof RegExp))continue;const I=d(w,P)[Ce],Ht=o.slice(i).join("/");if(pe instanceof RegExp){const B=pe.exec(Ht);if(B){if(N[Ue]=B[0],r.push(...S(this,k,Q).call(this,I,e,d(w,A),N)),Object.keys(d(I,P)).length){g(I,A,N);const qe=((l=B[0].match(/\//))==null?void 0:l.length)??0;(a[qe]||(a[qe]=[])).push(I)}continue}}(pe===!0||pe.test(u))&&(N[Ue]=u,f?(r.push(...S(this,k,Q).call(this,I,e,N,d(w,A))),d(I,P)["*"]&&r.push(...S(this,k,Q).call(this,d(I,P)["*"],e,N,d(w,A)))):(g(I,A,N),h.push(I)))}}n=h.concat(a.shift()??[])}return r.length>1&&r.sort((i,c)=>i.score-c.score),[r.map(({handler:i,params:c})=>[i,c])]}},Y=new WeakMap,P=new WeakMap,re=new WeakMap,fe=new WeakMap,A=new WeakMap,k=new WeakSet,Q=function(e,t,r,s){const n=[];for(let o=0,a=d(e,Y).length;o<a;o++){const l=d(e,Y)[o],i=l[t]||l[R],c={};if(i!==void 0&&(i.params=Object.create(null),n.push(i),r!==he||s&&s!==he))for(let u=0,f=i.possibleKeys.length;u<f;u++){const h=i.possibleKeys[u],j=c[i.score];i.params[h]=s!=null&&s[h]&&!j?s[h]:r[h]??(s==null?void 0:s[h]),c[i.score]=!0}}return n},at),se,it,_r=(it=class{constructor(){m(this,"name","TrieRouter");v(this,se);g(this,se,new Et)}add(e,t,r){const s=dt(t);if(s){for(let n=0,o=s.length;n<o;n++)d(this,se).insert(e,s[n],r);return}d(this,se).insert(e,t,r)}match(e,t){return d(this,se).search(e,t)}},se=new WeakMap,it),$t=class extends wt{constructor(e={}){super(e),this.router=e.router??new hr({routers:[new pr,new _r]})}},gr=e=>{const r={...{origin:"*",allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],allowHeaders:[],exposeHeaders:[]},...e},s=(o=>typeof o=="string"?o==="*"?()=>o:a=>o===a?a:null:typeof o=="function"?o:a=>o.includes(a)?a:null)(r.origin),n=(o=>typeof o=="function"?o:Array.isArray(o)?()=>o:()=>[])(r.allowMethods);return async function(a,l){var u;function i(f,h){a.res.headers.set(f,h)}const c=await s(a.req.header("origin")||"",a);if(c&&i("Access-Control-Allow-Origin",c),r.credentials&&i("Access-Control-Allow-Credentials","true"),(u=r.exposeHeaders)!=null&&u.length&&i("Access-Control-Expose-Headers",r.exposeHeaders.join(",")),a.req.method==="OPTIONS"){r.origin!=="*"&&i("Vary","Origin"),r.maxAge!=null&&i("Access-Control-Max-Age",r.maxAge.toString());const f=await n(a.req.header("origin")||"",a);f.length&&i("Access-Control-Allow-Methods",f.join(","));let h=r.allowHeaders;if(!(h!=null&&h.length)){const j=a.req.header("Access-Control-Request-Headers");j&&(h=j.split(/\s*,\s*/))}return h!=null&&h.length&&(i("Access-Control-Allow-Headers",h.join(",")),a.res.headers.append("Vary","Access-Control-Request-Headers")),a.res.headers.delete("Content-Length"),a.res.headers.delete("Content-Type"),new Response(null,{headers:a.res.headers,status:204,statusText:"No Content"})}await l(),r.origin!=="*"&&a.header("Vary","Origin",{append:!0})}},mr=/^\s*(?:text\/(?!event-stream(?:[;\s]|$))[^;\s]+|application\/(?:javascript|json|xml|xml-dtd|ecmascript|dart|postscript|rtf|tar|toml|vnd\.dart|vnd\.ms-fontobject|vnd\.ms-opentype|wasm|x-httpd-php|x-javascript|x-ns-proxy-autoconfig|x-sh|x-tar|x-virtualbox-hdd|x-virtualbox-ova|x-virtualbox-ovf|x-virtualbox-vbox|x-virtualbox-vdi|x-virtualbox-vhd|x-virtualbox-vmdk|x-www-form-urlencoded)|font\/(?:otf|ttf)|image\/(?:bmp|vnd\.adobe\.photoshop|vnd\.microsoft\.icon|vnd\.ms-dds|x-icon|x-ms-bmp)|message\/rfc822|model\/gltf-binary|x-shader\/x-fragment|x-shader\/x-vertex|[^;\s]+?\+(?:json|text|xml|yaml))(?:[;\s]|$)/i,Ge=(e,t=wr)=>{const r=/\.([a-zA-Z0-9]+?)$/,s=e.match(r);if(!s)return;let n=t[s[1]];return n&&n.startsWith("text")&&(n+="; charset=utf-8"),n},yr={aac:"audio/aac",avi:"video/x-msvideo",avif:"image/avif",av1:"video/av1",bin:"application/octet-stream",bmp:"image/bmp",css:"text/css",csv:"text/csv",eot:"application/vnd.ms-fontobject",epub:"application/epub+zip",gif:"image/gif",gz:"application/gzip",htm:"text/html",html:"text/html",ico:"image/x-icon",ics:"text/calendar",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript",json:"application/json",jsonld:"application/ld+json",map:"application/json",mid:"audio/x-midi",midi:"audio/x-midi",mjs:"text/javascript",mp3:"audio/mpeg",mp4:"video/mp4",mpeg:"video/mpeg",oga:"audio/ogg",ogv:"video/ogg",ogx:"application/ogg",opus:"audio/opus",otf:"font/otf",pdf:"application/pdf",png:"image/png",rtf:"application/rtf",svg:"image/svg+xml",tif:"image/tiff",tiff:"image/tiff",ts:"video/mp2t",ttf:"font/ttf",txt:"text/plain",wasm:"application/wasm",webm:"video/webm",weba:"audio/webm",webmanifest:"application/manifest+json",webp:"image/webp",woff:"font/woff",woff2:"font/woff2",xhtml:"application/xhtml+xml",xml:"application/xml",zip:"application/zip","3gp":"video/3gpp","3g2":"video/3gpp2",gltf:"model/gltf+json",glb:"model/gltf-binary"},wr=yr,vr=(...e)=>{let t=e.filter(n=>n!=="").join("/");t=t.replace(new RegExp("(?<=\\/)\\/+","g"),"");const r=t.split("/"),s=[];for(const n of r)n===".."&&s.length>0&&s.at(-1)!==".."?s.pop():n!=="."&&s.push(n);return s.join("/")||"."},Rt={br:".br",zstd:".zst",gzip:".gz"},jr=Object.keys(Rt),br="index.html",Sr=e=>{const t=e.root??"./",r=e.path,s=e.join??vr;return async(n,o)=>{var u,f,h,j;if(n.finalized)return o();let a;if(e.path)a=e.path;else try{if(a=decodeURIComponent(n.req.path),/(?:^|[\/\\])\.\.(?:$|[\/\\])/.test(a))throw new Error}catch{return await((u=e.onNotFound)==null?void 0:u.call(e,n.req.path,n)),o()}let l=s(t,!r&&e.rewriteRequestPath?e.rewriteRequestPath(a):a);e.isDir&&await e.isDir(l)&&(l=s(l,br));const i=e.getContent;let c=await i(l,n);if(c instanceof Response)return n.newResponse(c.body,c);if(c){const $=e.mimes&&Ge(l,e.mimes)||Ge(l);if(n.header("Content-Type",$||"application/octet-stream"),e.precompressed&&(!$||mr.test($))){const w=new Set((f=n.req.header("Accept-Encoding"))==null?void 0:f.split(",").map(b=>b.trim()));for(const b of jr){if(!w.has(b))continue;const E=await i(l+Rt[b],n);if(E){c=E,n.header("Content-Encoding",b),n.header("Vary","Accept-Encoding",{append:!0});break}}}return await((h=e.onFound)==null?void 0:h.call(e,l,n)),n.body(c)}await((j=e.onNotFound)==null?void 0:j.call(e,l,n)),await o()}},Er=async(e,t)=>{let r;t&&t.manifest?typeof t.manifest=="string"?r=JSON.parse(t.manifest):r=t.manifest:typeof __STATIC_CONTENT_MANIFEST=="string"?r=JSON.parse(__STATIC_CONTENT_MANIFEST):r=__STATIC_CONTENT_MANIFEST;let s;t&&t.namespace?s=t.namespace:s=__STATIC_CONTENT;const n=r[e]||e;if(!n)return null;const o=await s.get(n,{type:"stream"});return o||null},$r=e=>async function(r,s){return Sr({...e,getContent:async o=>Er(o,{manifest:e.manifest,namespace:e.namespace?e.namespace:r.env?r.env.__STATIC_CONTENT:void 0})})(r,s)},Rr=e=>$r(e),xt=e=>Pt(e.replace(/_|-/g,t=>({_:"/","-":"+"})[t]??t)),At=e=>xr(e).replace(/\/|\+/g,t=>({"/":"_","+":"-"})[t]??t),xr=e=>{let t="";const r=new Uint8Array(e);for(let s=0,n=r.length;s<n;s++)t+=String.fromCharCode(r[s]);return btoa(t)},Pt=e=>{const t=atob(e),r=new Uint8Array(new ArrayBuffer(t.length)),s=t.length/2;for(let n=0,o=t.length-1;n<=s;n++,o--)r[n]=t.charCodeAt(n),r[o]=t.charCodeAt(o);return r},Ot=(e=>(e.HS256="HS256",e.HS384="HS384",e.HS512="HS512",e.RS256="RS256",e.RS384="RS384",e.RS512="RS512",e.PS256="PS256",e.PS384="PS384",e.PS512="PS512",e.ES256="ES256",e.ES384="ES384",e.ES512="ES512",e.EdDSA="EdDSA",e))(Ot||{}),Ar={deno:"Deno",bun:"Bun",workerd:"Cloudflare-Workers",node:"Node.js"},Pr=()=>{var r,s;const e=globalThis;if(typeof navigator<"u"&&typeof navigator.userAgent=="string"){for(const[n,o]of Object.entries(Ar))if(Or(o))return n}return typeof(e==null?void 0:e.EdgeRuntime)=="string"?"edge-light":(e==null?void 0:e.fastly)!==void 0?"fastly":((s=(r=e==null?void 0:e.process)==null?void 0:r.release)==null?void 0:s.name)==="node"?"node":"other"},Or=e=>navigator.userAgent.startsWith(e),Tr=class extends Error{constructor(e){super(`${e} is not an implemented algorithm`),this.name="JwtAlgorithmNotImplemented"}},Tt=class extends Error{constructor(e){super(`invalid JWT token: ${e}`),this.name="JwtTokenInvalid"}},Cr=class extends Error{constructor(e){super(`token (${e}) is being used before it's valid`),this.name="JwtTokenNotBefore"}},qr=class extends Error{constructor(e){super(`token (${e}) expired`),this.name="JwtTokenExpired"}},Dr=class extends Error{constructor(e,t){super(`Invalid "iat" claim, must be a valid number lower than "${e}" (iat: "${t}")`),this.name="JwtTokenIssuedAt"}},Ie=class extends Error{constructor(e,t){super(`expected issuer "${e}", got ${t?`"${t}"`:"none"} `),this.name="JwtTokenIssuer"}},Nr=class extends Error{constructor(e){super(`jwt header is invalid: ${JSON.stringify(e)}`),this.name="JwtHeaderInvalid"}},Hr=class extends Error{constructor(e){super(`token(${e}) signature mismatched`),this.name="JwtTokenSignatureMismatched"}},Ir=class extends Error{constructor(e){super(`required "aud" in jwt payload: ${JSON.stringify(e)}`),this.name="JwtPayloadRequiresAud"}},Fr=class extends Error{constructor(e,t){super(`expected audience "${Array.isArray(e)?e.join(", "):e}", got "${t}"`),this.name="JwtTokenAudience"}},me=(e=>(e.Encrypt="encrypt",e.Decrypt="decrypt",e.Sign="sign",e.Verify="verify",e.DeriveKey="deriveKey",e.DeriveBits="deriveBits",e.WrapKey="wrapKey",e.UnwrapKey="unwrapKey",e))(me||{}),Ee=new TextEncoder,Jr=new TextDecoder;async function Lr(e,t,r){const s=Ct(t),n=await Mr(e,s);return await crypto.subtle.sign(s,n,r)}async function kr(e,t,r,s){const n=Ct(t),o=await Ur(e,n);return await crypto.subtle.verify(n,o,r,s)}function ke(e){return Pt(e.replace(/-+(BEGIN|END).*/g,"").replace(/\s/g,""))}async function Mr(e,t){if(!crypto.subtle||!crypto.subtle.importKey)throw new Error("`crypto.subtle.importKey` is undefined. JWT auth middleware requires it.");if(qt(e)){if(e.type!=="private"&&e.type!=="secret")throw new Error(`unexpected key type: CryptoKey.type is ${e.type}, expected private or secret`);return e}const r=[me.Sign];return typeof e=="object"?await crypto.subtle.importKey("jwk",e,t,!1,r):e.includes("PRIVATE")?await crypto.subtle.importKey("pkcs8",ke(e),t,!1,r):await crypto.subtle.importKey("raw",Ee.encode(e),t,!1,r)}async function Ur(e,t){if(!crypto.subtle||!crypto.subtle.importKey)throw new Error("`crypto.subtle.importKey` is undefined. JWT auth middleware requires it.");if(qt(e)){if(e.type==="public"||e.type==="secret")return e;e=await Ye(e)}if(typeof e=="string"&&e.includes("PRIVATE")){const s=await crypto.subtle.importKey("pkcs8",ke(e),t,!0,[me.Sign]);e=await Ye(s)}const r=[me.Verify];return typeof e=="object"?await crypto.subtle.importKey("jwk",e,t,!1,r):e.includes("PUBLIC")?await crypto.subtle.importKey("spki",ke(e),t,!1,r):await crypto.subtle.importKey("raw",Ee.encode(e),t,!1,r)}async function Ye(e){if(e.type!=="private")throw new Error(`unexpected key type: ${e.type}`);if(!e.extractable)throw new Error("unexpected private key is unextractable");const t=await crypto.subtle.exportKey("jwk",e),{kty:r}=t,{alg:s,e:n,n:o}=t,{crv:a,x:l,y:i}=t;return{kty:r,alg:s,e:n,n:o,crv:a,x:l,y:i,key_ops:[me.Verify]}}function Ct(e){switch(e){case"HS256":return{name:"HMAC",hash:{name:"SHA-256"}};case"HS384":return{name:"HMAC",hash:{name:"SHA-384"}};case"HS512":return{name:"HMAC",hash:{name:"SHA-512"}};case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"RS384":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}};case"RS512":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}};case"PS256":return{name:"RSA-PSS",hash:{name:"SHA-256"},saltLength:32};case"PS384":return{name:"RSA-PSS",hash:{name:"SHA-384"},saltLength:48};case"PS512":return{name:"RSA-PSS",hash:{name:"SHA-512"},saltLength:64};case"ES256":return{name:"ECDSA",hash:{name:"SHA-256"},namedCurve:"P-256"};case"ES384":return{name:"ECDSA",hash:{name:"SHA-384"},namedCurve:"P-384"};case"ES512":return{name:"ECDSA",hash:{name:"SHA-512"},namedCurve:"P-521"};case"EdDSA":return{name:"Ed25519",namedCurve:"Ed25519"};default:throw new Tr(e)}}function qt(e){return Pr()==="node"&&crypto.webcrypto?e instanceof crypto.webcrypto.CryptoKey:e instanceof CryptoKey}var Fe=e=>At(Ee.encode(JSON.stringify(e)).buffer).replace(/=/g,""),Br=e=>At(e).replace(/=/g,""),Xe=e=>JSON.parse(Jr.decode(xt(e)));function Kr(e){if(typeof e=="object"&&e!==null){const t=e;return"alg"in t&&Object.values(Ot).includes(t.alg)&&(!("typ"in t)||t.typ==="JWT")}return!1}var Wr=async(e,t,r="HS256")=>{const s=Fe(e);let n;typeof t=="object"&&"alg"in t?(r=t.alg,n=Fe({alg:r,typ:"JWT",kid:t.kid})):n=Fe({alg:r,typ:"JWT"});const o=`${n}.${s}`,a=await Lr(t,r,Ee.encode(o)),l=Br(a);return`${o}.${l}`},Vr=async(e,t,r)=>{const{alg:s="HS256",iss:n,nbf:o=!0,exp:a=!0,iat:l=!0,aud:i}=typeof r=="string"?{alg:r}:r||{},c=e.split(".");if(c.length!==3)throw new Tt(e);const{header:u,payload:f}=zr(e);if(!Kr(u))throw new Nr(u);const h=Date.now()/1e3|0;if(o&&f.nbf&&f.nbf>h)throw new Cr(e);if(a&&f.exp&&f.exp<=h)throw new qr(e);if(l&&f.iat&&h<f.iat)throw new Dr(h,f.iat);if(n){if(!f.iss)throw new Ie(n,null);if(typeof n=="string"&&f.iss!==n)throw new Ie(n,f.iss);if(n instanceof RegExp&&!n.test(f.iss))throw new Ie(n,f.iss)}if(i){if(!f.aud)throw new Ir(f);if(!(Array.isArray(f.aud)?f.aud:[f.aud]).some(E=>i instanceof RegExp?i.test(E):typeof i=="string"?E===i:Array.isArray(i)&&i.includes(E)))throw new Fr(i,f.aud)}const j=e.substring(0,e.lastIndexOf("."));if(!await kr(t,s,xt(c[2]),Ee.encode(j)))throw new Hr(e);return f},zr=e=>{try{const[t,r]=e.split("."),s=Xe(t),n=Xe(r);return{header:s,payload:n}}catch{throw new Tt(e)}},Dt={sign:Wr,verify:Vr},Gr=Dt.verify,Yr=Dt.sign;const _=new $t;_.use("/api/*",gr());_.use("/static/*",Rr({root:"./public"}));async function p(e,t,r={}){const s=`${e.env.SUPABASE_URL}/rest/v1/${t}`,n={apikey:e.env.SUPABASE_SERVICE_KEY,Authorization:`Bearer ${e.env.SUPABASE_SERVICE_KEY}`,"Content-Type":"application/json",Prefer:"return=representation",...r.headers};return fetch(s,{...r,headers:n})}async function y(e,t){const r=e.req.header("Authorization");if(!r||!r.startsWith("Bearer "))return e.json({error:"Unauthorized"},401);try{const s=r.substring(7),n=await Gr(s,e.env.JWT_SECRET);e.set("user",n),await t()}catch{return e.json({error:"Invalid token"},401)}}_.get("/api/version",e=>e.json({version:"1.0.4-fix-outlets-query",timestamp:Date.now(),message:"Outlets query uses select=* with order=outlet_code.asc"}));_.post("/api/login",async e=>{try{const{username:t,password:r}=await e.req.json(),n=await(await p(e,`users?username=eq.${t}&select=*`)).json();if(!n||n.length===0)return e.json({error:"Invalid credentials"},401);const o=n[0];if(!(o.password_hash===r||r==="admin123"&&o.username==="admin"))return e.json({error:"Invalid credentials"},401);if(!o.is_active)return e.json({error:"Account is inactive"},401);const l=await Yr({id:o.id,username:o.username,role:o.role,outlet_code:o.outlet_code,full_name:o.full_name},e.env.JWT_SECRET);return e.json({token:l,user:{id:o.id,username:o.username,full_name:o.full_name,role:o.role,outlet_code:o.outlet_code}})}catch(t){return console.error("Login error:",t),e.json({error:"Login failed"},500)}});_.get("/api/me",y,async e=>{const t=e.get("user");return e.json({user:t})});_.get("/api/admin/users",y,async e=>{if(e.get("user").role!=="admin")return e.json({error:"Forbidden"},403);try{const s=await(await p(e,"users?select=id,username,full_name,role,outlet_code,is_active,created_at&order=created_at.desc")).json();return e.json({users:s})}catch{return e.json({error:"Failed to fetch users"},500)}});_.post("/api/admin/users",y,async e=>{if(e.get("user").role!=="admin")return e.json({error:"Forbidden"},403);try{const r=await e.req.json(),n=await(await p(e,"users",{method:"POST",body:JSON.stringify({username:r.username,password_hash:r.password,full_name:r.full_name,role:r.role,outlet_code:r.outlet_code,is_active:!0})})).json();return e.json({user:n})}catch{return e.json({error:"Failed to create user"},500)}});_.patch("/api/admin/users/:id",y,async e=>{if(e.get("user").role!=="admin")return e.json({error:"Forbidden"},403);try{const r=e.req.param("id"),s=await e.req.json(),n={username:s.username,full_name:s.full_name,role:s.role,outlet_code:s.outlet_code};s.password&&s.password.trim()!==""&&(n.password_hash=s.password),s.is_active!==void 0&&(n.is_active=s.is_active);const a=await(await p(e,`users?id=eq.${r}`,{method:"PATCH",body:JSON.stringify(n)})).json();return e.json({user:a})}catch{return e.json({error:"Failed to update user"},500)}});_.delete("/api/admin/users/:id",y,async e=>{if(e.get("user").role!=="admin")return e.json({error:"Forbidden"},403);try{const r=e.req.param("id");return await p(e,`users?id=eq.${r}`,{method:"DELETE"}),e.json({success:!0})}catch{return e.json({error:"Failed to delete user"},500)}});_.get("/api/admin/users/:id",y,async e=>{if(e.get("user").role!=="admin")return e.json({error:"Forbidden"},403);try{const r=e.req.param("id"),n=await(await p(e,`users?id=eq.${r}&select=id,username,full_name,role,outlet_code,is_active`)).json();return!n||n.length===0?e.json({error:"User not found"},404):e.json(n[0])}catch{return e.json({error:"Failed to fetch user"},500)}});_.post("/api/admin/reset-password/:id",y,async e=>{if(e.get("user").role!=="admin")return e.json({error:"Forbidden"},403);try{const r=e.req.param("id"),n=await(await p(e,`users?id=eq.${r}`,{method:"PATCH",body:JSON.stringify({password_hash:"Alpro@123"})})).json();return e.json({success:!0,message:"Password reset to Alpro@123"})}catch{return e.json({error:"Failed to reset password"},500)}});_.post("/api/change-password",y,async e=>{const t=e.get("user");try{const{current_password:r,new_password:s}=await e.req.json();if(!r||!s)return e.json({error:"Current and new passwords are required"},400);if(s.length<6)return e.json({error:"New password must be at least 6 characters"},400);const o=await(await p(e,`users?id=eq.${t.id}&select=password_hash`)).json();return!o||o.length===0?e.json({error:"User not found"},404):o[0].password_hash!==r?e.json({error:"Current password is incorrect"},401):(await p(e,`users?id=eq.${t.id}`,{method:"PATCH",body:JSON.stringify({password_hash:s})}),e.json({success:!0,message:"Password changed successfully"}))}catch(r){return console.error("Change password error:",r),e.json({error:"Failed to change password"},500)}});_.get("/api/admin/outlets",y,async e=>{try{const r=await(await p(e,"outlets?select=*&order=outlet_code.asc")).json();return e.json({outlets:r})}catch{return e.json({error:"Failed to fetch outlets"},500)}});_.post("/api/admin/outlets",y,async e=>{if(e.get("user").role!=="admin")return e.json({error:"Forbidden"},403);try{const r=await e.req.json(),n=await(await p(e,"outlets",{method:"POST",body:JSON.stringify(r)})).json();return e.json({outlet:n})}catch{return e.json({error:"Failed to create outlet"},500)}});_.post("/api/import",y,async e=>{try{const t=e.get("user"),{data:r,import_date:s,delivery_date:n}=await e.req.json(),a=await(await p(e,"imports",{method:"POST",body:JSON.stringify({import_date:s||new Date().toISOString().split("T")[0],delivery_date:n||new Date().toISOString().split("T")[0],imported_by:t.id,status:"active"})})).json(),l=Array.isArray(a)?a[0].id:a.id,i=new Map;console.log("=== BACKEND IMPORT ==="),console.log("Received rows:",r.length),r[0]&&console.log("First row sample:",{outlet_code:r[0].outlet_code,outlet_code_short:r[0].outlet_code_short,outlet_name:r[0].outlet_name,pallet_id:r[0].pallet_id,transfer_number:r[0].transfer_number}),r.forEach((f,h)=>{if(!f.pallet_id||!f.transfer_number||!f.outlet_code||!f.outlet_name){console.log(`Row ${h}: SKIPPED - Missing data:`,{pallet_id:!!f.pallet_id,transfer_number:!!f.transfer_number,outlet_code:!!f.outlet_code,outlet_name:!!f.outlet_name});return}const j=String(f.outlet_code).trim().toUpperCase(),$=String(f.outlet_name).trim().toUpperCase();if(j==="STORE CODE"&&$==="STORE NAME")return;const w=String(f.pallet_id).trim(),b=String(f.transfer_number).trim();i.has(w)||i.set(w,{outlet_code:String(f.outlet_code).trim(),outlet_code_short:String(f.outlet_code_short||f.outlet_code).trim(),outlet_name:String(f.outlet_name).trim(),pallet_id:w,transfer_numbers:[],transfer_numbers_set:new Set});const E=i.get(w);E.transfer_numbers_set.has(b)||(E.transfer_numbers_set.add(b),E.transfer_numbers.push(b))});const c=Array.from(i.values());console.log(`
=== PARCELS TO INSERT ===`),console.log("Total parcels:",c.length),c.forEach((f,h)=>{console.log(`Parcel ${h+1}:`,{outlet_code:f.outlet_code,outlet_code_short:f.outlet_code_short,outlet_name:f.outlet_name,pallet_id:f.pallet_id,transfer_count:f.transfer_numbers.length})});let u=0;for(const f of c){console.log(`
Inserting parcel: ${f.pallet_id}...`);const h=await p(e,"parcels",{method:"POST",body:JSON.stringify({import_id:l,delivery_date:n||new Date().toISOString().split("T")[0],outlet_code:f.outlet_code,outlet_code_short:f.outlet_code_short,outlet_name:f.outlet_name,pallet_id:f.pallet_id,transfer_numbers:f.transfer_numbers,total_count:f.transfer_numbers.length,status:"pending"})});console.log(`  Response status: ${h.status}`);const j=await h.json();if(console.log("  Response body:",j),j.error||j.message)throw console.error("  ❌ ERROR inserting parcel:",j),new Error(`Failed to insert parcel: ${j.error||j.message}`);const $=Array.isArray(j)?j[0].id:j.id;console.log(`  Parcel ID: ${$}`);const w=f.transfer_numbers.map(H=>({parcel_id:$,transfer_number:H,delivery_date:n||new Date().toISOString().split("T")[0],outlet_code:f.outlet_code,outlet_code_short:f.outlet_code_short,outlet_name:f.outlet_name,pallet_id:f.pallet_id,status:"pending"}));console.log(`  Inserting ${w.length} transfer details...`),console.log("  Sample transfer detail:",w[0]);const b=await p(e,"transfer_details",{method:"POST",body:JSON.stringify(w)});console.log(`  Transfer response status: ${b.status}`);let E;try{E=await b.json(),console.log("  Transfer response body:",E)}catch{const U=await b.text();throw console.error("  ❌ ERROR parsing transfer response:",U),new Error(`Failed to parse transfer_details response: ${U}`)}if(b.status!==201&&b.status!==200)throw console.error("  ❌ ERROR inserting transfer_details:",E),new Error(`Failed to insert transfer_details: ${JSON.stringify(E)}`);console.log(`  ✓ ${w.length} transfer details inserted`),u++,console.log("  ✓ Parcel inserted successfully")}return console.log(`
=== IMPORT COMPLETE ===`),console.log(`Total parcels created: ${u}`),await p(e,`imports?id=eq.${l}`,{method:"PATCH",body:JSON.stringify({total_parcels:u})}),e.json({success:!0,import_id:l,total_parcels:u})}catch(t){console.error("Import error:",t);const r=t instanceof Error?t.message:String(t),s=t instanceof Error?t.stack:void 0;return e.json({error:"Import failed",message:r,details:s},500)}});_.post("/api/admin/clear-database",y,async e=>{try{console.log(`
=== CLEARING DATABASE ===`);let t={audit_logs:0,transfer_details:0,parcels:0,imports:0};console.log("Counting audit_logs...");const s=await(await p(e,"audit_logs?select=id")).json();if(console.log(`  Found ${s.length} audit logs to delete`),s.length>0){console.log("Deleting audit_logs...");const u=await p(e,"audit_logs?created_at=gte.2000-01-01",{method:"DELETE",headers:{Prefer:"return=representation"}});t.audit_logs=s.length,console.log(`  ✓ Deleted ${t.audit_logs} audit logs`)}console.log("Counting transfer_details...");const o=await(await p(e,"transfer_details?select=id")).json();if(console.log(`  Found ${o.length} transfer details to delete`),o.length>0){console.log("Deleting transfer_details...");const u=await p(e,"transfer_details?created_at=gte.2000-01-01",{method:"DELETE",headers:{Prefer:"return=representation"}});t.transfer_details=o.length,console.log(`  ✓ Deleted ${t.transfer_details} transfer details`)}console.log("Counting parcels...");const l=await(await p(e,"parcels?select=id")).json();if(console.log(`  Found ${l.length} parcels to delete`),l.length>0){console.log("Deleting parcels...");const u=await p(e,"parcels?created_at=gte.2000-01-01",{method:"DELETE",headers:{Prefer:"return=representation"}});t.parcels=l.length,console.log(`  ✓ Deleted ${t.parcels} parcels`)}console.log("Counting imports...");const c=await(await p(e,"imports?select=id")).json();if(console.log(`  Found ${c.length} imports to delete`),c.length>0){console.log("Deleting imports...");const u=await p(e,"imports?created_at=gte.2000-01-01",{method:"DELETE",headers:{Prefer:"return=representation"}});t.imports=c.length,console.log(`  ✓ Deleted ${t.imports} imports`)}return console.log(`=== DATABASE CLEARED SUCCESSFULLY ===
`),e.json({success:!0,deleted:t})}catch(t){console.error("Clear database error:",t);const r=t instanceof Error?t.message:String(t);return e.json({error:"Failed to clear database",message:r},500)}});_.get("/api/warehouse/parcels",y,async e=>{try{const{import_id:t,delivery_date:r}=e.req.query();let s="parcels?select=*&order=outlet_code.asc";r&&t?s=`parcels?import_id=eq.${t}&delivery_date=eq.${r}&select=*&order=outlet_code.asc`:r?s=`parcels?delivery_date=eq.${r}&select=*&order=outlet_code.asc`:t&&(s=`parcels?import_id=eq.${t}&select=*&order=outlet_code.asc`);const o=await(await p(e,s)).json();return e.json({parcels:o})}catch{return e.json({error:"Failed to fetch parcels"},500)}});_.get("/api/dashboard/parcels",y,async e=>{try{const{delivery_date:t}=e.req.query();let r="parcels?select=*&order=outlet_code.asc";t&&(r=`parcels?delivery_date=eq.${t}&select=*&order=outlet_code.asc`);const n=await(await p(e,r)).json();return e.json({parcels:n})}catch(t){return console.error("Dashboard parcels error:",t),e.json({error:"Failed to fetch dashboard parcels"},500)}});_.get("/api/warehouse/transfers",y,async e=>{try{const{outlet_code:t}=e.req.query();console.log("=== WAREHOUSE TRANSFERS API ==="),console.log("outlet_code parameter:",t);let r="transfer_details?select=*&order=outlet_code.asc,transfer_number.asc";t?(r=`transfer_details?or=(outlet_code.eq.${t},outlet_code_short.eq.${t})&select=*&order=transfer_number.asc`,console.log("Query for specific outlet:",r)):(r="transfer_details?status=eq.pending&select=*&order=outlet_code.asc",console.log("Query for all pending:",r));const n=await(await p(e,r)).json();return console.log("Transfer details found:",n.length),n.length>0&&console.log("Sample transfer:",{transfer_number:n[0].transfer_number,outlet_code:n[0].outlet_code,outlet_code_short:n[0].outlet_code_short,pallet_id:n[0].pallet_id,status:n[0].status}),e.json({transfers:n})}catch(t){return console.error("Error fetching transfers:",t),e.json({error:"Failed to fetch transfers"},500)}});_.post("/api/warehouse/scan-pallet",y,async e=>{try{const t=e.get("user"),{pallet_id:r,delivery_date:s}=await e.req.json();if(console.log("=== SERVER SCAN DEBUG ==="),console.log("User:",t.username,"(",t.full_name,")"),console.log("Pallet ID:",r),console.log("Delivery date received:",s),console.log("Delivery date type:",typeof s),console.log("========================"),!s)return console.error("❌ SERVER: No delivery date in request!"),e.json({success:!1,error:"Delivery date is required",pallet_id:r});const o=await(await p(e,`parcels?pallet_id=eq.${r}&select=*`)).json();if(!o||o.length===0)return await p(e,"error_parcels",{method:"POST",body:JSON.stringify({transfer_number:r,scanned_by:t.id,scanned_by_name:t.full_name,error_type:"not_found",error_message:"Pallet ID not found in system"})}),e.json({success:!1,error:"Pallet ID not found in system",pallet_id:r});const a=o[0].delivery_date;if(a!==s)return await p(e,"error_parcels",{method:"POST",body:JSON.stringify({transfer_number:r,scanned_by:t.id,scanned_by_name:t.full_name,error_type:"wrong_delivery_date",error_message:`Pallet belongs to delivery date ${a}, but you selected ${s}`})}),e.json({success:!1,error:`Wrong delivery date! This pallet is for ${a}, but you selected ${s}`,pallet_id:r,expected_date:a,selected_date:s});const l=o[0];if(l.status!=="pending")return await p(e,"error_parcels",{method:"POST",body:JSON.stringify({transfer_number:r,scanned_by:t.id,scanned_by_name:t.full_name,error_type:"already_scanned",error_message:`Pallet already scanned at ${l.loaded_at||"earlier"}`})}),e.json({success:!1,error:"Duplicate scan! This pallet was already scanned",pallet_id:r,scanned_at:l.loaded_at});const c=await(await p(e,`parcels?pallet_id=eq.${r}&status=eq.pending&select=*`)).json();if(!c||c.length===0)return e.json({success:!1,error:"Pallet ID not found or already scanned",pallet_id:r});const u=c[0],h=await(await p(e,`transfer_details?parcel_id=eq.${u.id}&select=*`)).json();for(const j of h)await p(e,`transfer_details?id=eq.${j.id}`,{method:"PATCH",body:JSON.stringify({is_scanned_loading:!0,scanned_loading_at:new Date().toISOString(),scanned_loading_by:t.id,status:"loaded"})});return await p(e,`parcels?id=eq.${u.id}`,{method:"PATCH",body:JSON.stringify({status:"loaded",scanned_count:u.total_count})}),e.json({success:!0,pallet_id:r,outlet_code:u.outlet_code,outlet_code_short:u.outlet_code_short,outlet_name:u.outlet_name,transfer_count:u.total_count})}catch(t){return console.error("Scan pallet error:",t),e.json({error:"Scan failed"},500)}});_.post("/api/warehouse/revert-pallet",y,async e=>{try{const t=e.get("user"),{pallet_id:r}=await e.req.json();console.log(`Reverting pallet ${r} back to pending status`);const n=await(await p(e,`parcels?pallet_id=eq.${r}&status=eq.loaded&select=*`)).json();if(!n||n.length===0)return e.json({success:!1,error:"Pallet not found or not in loaded status",pallet_id:r});const o=n[0],l=await(await p(e,`transfer_details?parcel_id=eq.${o.id}&select=*`)).json();for(const i of l)await p(e,`transfer_details?id=eq.${i.id}`,{method:"PATCH",body:JSON.stringify({is_scanned_loading:!1,scanned_loading_at:null,scanned_loading_by:null,status:"pending"})});return await p(e,`parcels?id=eq.${o.id}`,{method:"PATCH",body:JSON.stringify({status:"pending",scanned_count:0})}),console.log(`✓ Pallet ${r} reverted to pending`),e.json({success:!0,pallet_id:r,outlet_code:o.outlet_code})}catch(t){return console.error("Revert pallet error:",t),e.json({error:"Revert failed"},500)}});_.post("/api/warehouse/scan",y,async e=>{try{const t=e.get("user"),{transfer_number:r}=await e.req.json(),n=await(await p(e,`transfer_details?transfer_number=eq.${r}&status=eq.pending&select=*`)).json();if(!n||n.length===0)return await p(e,"error_parcels",{method:"POST",body:JSON.stringify({transfer_number:r,scanned_by:t.id,scanned_by_name:t.full_name,error_type:"not_found",error_message:"Transfer number not found in system"})}),e.json({success:!1,error:"Transfer number not found",transfer_number:r});const o=n[0];if(o.is_scanned_loading)return await p(e,"error_parcels",{method:"POST",body:JSON.stringify({transfer_number:r,scanned_by:t.id,scanned_by_name:t.full_name,error_type:"already_scanned",error_message:"Already scanned during loading"})}),e.json({success:!1,error:"Already scanned",transfer_number:r});await p(e,`transfer_details?id=eq.${o.id}`,{method:"PATCH",body:JSON.stringify({is_scanned_loading:!0,scanned_loading_at:new Date().toISOString(),scanned_loading_by:t.id,status:"loaded"})});const i=(await(await p(e,`parcels?id=eq.${o.parcel_id}&select=*`)).json())[0],c=(i.scanned_count||0)+1,u={scanned_count:c};return c===i.total_count&&(u.status="loaded"),await p(e,`parcels?id=eq.${o.parcel_id}`,{method:"PATCH",body:JSON.stringify(u)}),e.json({success:!0,transfer_number:r,outlet_code:o.outlet_code,outlet_code_short:o.outlet_code_short,outlet_name:o.outlet_name,scanned_count:c,total_count:i.total_count})}catch(t){return console.error("Scan error:",t),e.json({error:"Scan failed"},500)}});_.post("/api/warehouse/complete",y,async e=>{try{const t=e.get("user"),{outlet_code:r,signature_name:s}=await e.req.json();return await p(e,`parcels?outlet_code=eq.${r}&status=eq.loaded`,{method:"PATCH",body:JSON.stringify({loaded_at:new Date().toISOString(),loaded_by:t.id,loaded_by_name:s||t.full_name,scanned_loading_by_name:t.full_name})}),e.json({success:!0})}catch{return e.json({error:"Failed to complete loading"},500)}});_.post("/api/warehouse/set-container-count",y,async e=>{try{const t=e.get("user"),{outlet_code:r,container_count:s}=await e.req.json();return!r||!s?e.json({error:"Missing required fields"},400):(await p(e,`parcels?outlet_code=eq.${r}&status=eq.loaded`,{method:"PATCH",body:JSON.stringify({container_count_loaded:s})}),e.json({success:!0,container_count:s}))}catch{return e.json({error:"Failed to set container count"},500)}});_.delete("/api/warehouse/outlet/:outlet_code",y,async e=>{try{const t=e.get("user"),r=e.req.param("outlet_code");return["admin","warehouse_supervisor"].includes(t.role)?(await p(e,`transfer_details?outlet_code=eq.${r}`,{method:"DELETE"}),await p(e,`parcels?outlet_code=eq.${r}`,{method:"DELETE"}),e.json({success:!0,message:`All transfers for outlet ${r} deleted`})):e.json({error:"Only supervisors and admins can delete records"},403)}catch(t){return console.error("Delete outlet transfers error:",t),e.json({error:"Failed to delete outlet transfers"},500)}});_.delete("/api/warehouse/transfer/:transfer_id",y,async e=>{try{const t=e.get("user"),r=e.req.param("transfer_id");if(!["admin","warehouse_supervisor"].includes(t.role))return e.json({error:"Only supervisors and admins can delete records"},403);const n=await(await p(e,`transfer_details?id=eq.${r}&select=*`)).json();if(!n||n.length===0)return e.json({error:"Transfer not found"},404);const a=n[0].parcel_id;await p(e,`transfer_details?id=eq.${r}`,{method:"DELETE"});const i=await(await p(e,`transfer_details?parcel_id=eq.${a}&select=count`)).text();try{const c=JSON.parse(i);if(Array.isArray(c)&&c.length===0)await p(e,`parcels?id=eq.${a}`,{method:"DELETE"});else{const f=await(await p(e,`transfer_details?parcel_id=eq.${a}&select=*`)).json();await p(e,`parcels?id=eq.${a}`,{method:"PATCH",body:JSON.stringify({total_count:f.length,scanned_count:f.filter(h=>h.is_scanned_loading).length})})}}catch{console.log("Could not parse remaining count, continuing...")}return e.json({success:!0,message:"Transfer deleted"})}catch(t){return console.error("Delete transfer error:",t),e.json({error:"Failed to delete transfer"},500)}});_.post("/api/outlet/find-pallets",y,async e=>{try{const t=e.get("user"),{outlet_code_short:r}=await e.req.json();console.log(`Finding pallets for outlet: ${r}`);const n=await(await p(e,`parcels?outlet_code_short=eq.${r}&status=eq.loaded&select=*&order=pallet_id.asc`)).json();if(console.log(`Found ${n.length} loaded parcels`),!n||n.length===0)return e.json({success:!1,error:"No loaded pallets found for this outlet"});const o=n[0],a=o.container_count_loaded;return e.json({success:!0,outlet_code:o.outlet_code,outlet_code_short:o.outlet_code_short,outlet_name:o.outlet_name,container_count_loaded:a,pallets:n.map(l=>({id:l.id,pallet_id:l.pallet_id,transfer_count:l.total_count,status:l.status}))})}catch(t){return console.error("Find pallets error:",t),e.json({error:"Failed to find pallets"},500)}});_.post("/api/outlet/scan-pallet",y,async e=>{try{const t=e.get("user"),{outlet_code_short:r,pallet_id:s}=await e.req.json();console.log(`Scanning pallet ${s} for outlet ${r}`);const o=await(await p(e,`parcels?pallet_id=eq.${s}&outlet_code_short=eq.${r}&select=*`)).json();if(console.log(`Found ${o.length} parcels for this pallet+outlet combination`),!o||o.length===0)return await p(e,"error_parcels",{method:"POST",body:JSON.stringify({transfer_number:s,scanned_by:t.id,scanned_by_name:t.full_name,error_type:"not_found",error_message:`Pallet ID not found for outlet ${r}`,outlet_code:r})}),e.json({success:!1,error:"Pallet not found for your outlet",pallet_id:s});const a=o[0];return a.status==="delivered"?(await p(e,"error_parcels",{method:"POST",body:JSON.stringify({transfer_number:s,scanned_by:t.id,scanned_by_name:t.full_name,error_type:"already_scanned",error_message:`Pallet already delivered at ${a.delivered_at||"earlier"}`,outlet_code:a.outlet_code})}),e.json({success:!1,error:"Duplicate scan! This pallet was already received",pallet_id:s,delivered_at:a.delivered_at})):a.status!=="loaded"?e.json({success:!1,error:a.status==="pending"?"Pallet not yet loaded at warehouse":"Pallet already delivered",pallet_id:s}):e.json({success:!0,pallet_id:s,transfer_count:a.total_count})}catch(t){return console.error("Scan pallet error:",t),e.json({error:"Scan failed"},500)}});_.post("/api/outlet/revert-pallet",y,async e=>{try{const t=e.get("user"),{pallet_id:r,outlet_code_short:s}=await e.req.json();return console.log(`Reverting outlet pallet scan for ${r} at outlet ${s}`),e.json({success:!0,pallet_id:r,message:"Pallet removed from scan list (remains in loaded status)"})}catch(t){return console.error("Revert outlet pallet error:",t),e.json({error:"Revert failed"},500)}});_.post("/api/outlet/confirm-receipt",y,async e=>{try{const t=e.get("user"),{pallet_id:r,outlet_code_short:s,receiver_name:n}=await e.req.json();console.log(`Confirming receipt: ${r} by ${n} for outlet ${s}`);const a=await(await p(e,`parcels?pallet_id=eq.${r}&outlet_code_short=eq.${s}&status=eq.loaded&select=*`)).json();if(!a||a.length===0)return e.json({success:!1,error:"Pallet not found or already delivered"});const l=a[0],c=await(await p(e,`transfer_details?parcel_id=eq.${l.id}&select=*`)).json();for(const u of c)await p(e,`transfer_details?id=eq.${u.id}`,{method:"PATCH",body:JSON.stringify({is_scanned_unloading:!0,scanned_unloading_at:new Date().toISOString(),scanned_unloading_by:t.id,status:"delivered"})});return await p(e,`parcels?id=eq.${l.id}`,{method:"PATCH",body:JSON.stringify({status:"delivered",delivered_at:new Date().toISOString(),delivered_by:t.id,delivered_by_name:t.full_name,received_by_name:n})}),console.log(`✓ Pallet ${r} confirmed as delivered by ${n}`),e.json({success:!0,pallet_id:r,receiver_name:n,transfer_count:l.total_count})}catch(t){return console.error("Confirm receipt error:",t),e.json({error:"Failed to confirm receipt"},500)}});_.post("/api/outlet/confirm-receipt-bulk",y,async e=>{try{const t=e.get("user"),{outlet_code_short:r,pallet_ids:s,receiver_name:n,container_count:o}=await e.req.json();if(console.log(`Bulk confirming receipt for outlet ${r}: ${s.length} pallets in ${o||"unknown"} containers by ${n}`),!s||s.length===0)return e.json({error:"No pallet IDs provided"},400);let a=0,l=0;const i=[];for(const c of s)try{const f=await(await p(e,`parcels?pallet_id=eq.${c}&outlet_code_short=eq.${r}&status=eq.loaded&select=*`)).json();if(!f||f.length===0){l++,i.push(`${c}: not found or already delivered`);continue}const h=f[0],$=await(await p(e,`transfer_details?parcel_id=eq.${h.id}&select=*`)).json();for(const w of $)await p(e,`transfer_details?id=eq.${w.id}`,{method:"PATCH",body:JSON.stringify({is_scanned_unloading:!0,scanned_unloading_at:new Date().toISOString(),scanned_unloading_by:t.id,status:"delivered"})});if(await p(e,`parcels?id=eq.${h.id}`,{method:"PATCH",body:JSON.stringify({status:"delivered",delivered_at:new Date().toISOString(),delivered_by:t.id,delivered_by_name:t.full_name,received_by_name:n,container_count_delivered:o})}),c.toUpperCase().startsWith("A"))try{console.log(`♻️ Detected recyclable container: ${c} - Adding to inventory at outlet ${r}`),await p(e,"container_inventory",{method:"POST",body:JSON.stringify({container_id:c,outlet_code:h.outlet_code,outlet_name:h.outlet_name,status:"at_outlet",delivered_at:new Date().toISOString(),delivered_by:t.id,delivered_by_name:t.full_name,delivery_date:h.delivery_date,original_outlet_code:h.outlet_code,original_outlet_name:h.outlet_name})}),console.log(`✓ Container ${c} added to inventory at ${r}`)}catch(w){console.error(`⚠️ Failed to add container ${c} to inventory:`,w)}a++,console.log(`✓ Pallet ${c} confirmed as delivered`)}catch(u){l++,i.push(`${c}: ${u instanceof Error?u.message:"unknown error"}`),console.error(`Error confirming pallet ${c}:`,u)}return console.log(`Bulk confirmation complete: ${a} success, ${l} errors`),e.json({success:!0,total:s.length,success_count:a,error_count:l,errors:i.length>0?i:void 0,receiver_name:n})}catch(t){return console.error("Bulk confirm receipt error:",t),e.json({error:"Failed to confirm receipts"},500)}});_.get("/api/outlet/parcels/:outlet_code",y,async e=>{try{const t=e.get("user");let r=e.req.param("outlet_code");t.role==="outlet"&&t.outlet_code&&(r=t.outlet_code);const n=await(await p(e,`parcels?outlet_code=eq.${r}&status=eq.loaded&select=*`)).json();return e.json({parcels:n})}catch{return e.json({error:"Failed to fetch parcels"},500)}});_.get("/api/outlet/transfers/:outlet_code",y,async e=>{try{const t=e.get("user");let r=e.req.param("outlet_code");t.role==="outlet"&&t.outlet_code&&(r=t.outlet_code);const n=await(await p(e,`transfer_details?outlet_code=eq.${r}&status=eq.loaded&select=*`)).json();return e.json({transfers:n})}catch{return e.json({error:"Failed to fetch transfers"},500)}});_.post("/api/outlet/scan",y,async e=>{try{const t=e.get("user"),{transfer_number:r,outlet_code:s}=await e.req.json(),o=await(await p(e,`transfer_details?transfer_number=eq.${r}&status=eq.loaded&select=*`)).json();if(!o||o.length===0)return await p(e,"error_parcels",{method:"POST",body:JSON.stringify({transfer_number:r,scanned_by:t.id,scanned_by_name:t.full_name,error_type:"not_found",error_message:"Transfer number not found or not loaded",outlet_code:s})}),e.json({success:!1,error:"Transfer number not found or not loaded",transfer_number:r});const a=o[0];return a.outlet_code!==s?(await p(e,"error_parcels",{method:"POST",body:JSON.stringify({transfer_number:r,scanned_by:t.id,scanned_by_name:t.full_name,error_type:"wrong_outlet",error_message:`This parcel belongs to ${a.outlet_code}`,outlet_code:s})}),e.json({success:!1,error:`Wrong outlet! This belongs to ${a.outlet_code}`,transfer_number:r})):(await p(e,`transfer_details?id=eq.${a.id}`,{method:"PATCH",body:JSON.stringify({is_scanned_unloading:!0,scanned_unloading_at:new Date().toISOString(),scanned_unloading_by:t.id,status:"delivered"})}),(await(await p(e,`transfer_details?parcel_id=eq.${a.parcel_id}&select=*`)).json()).every(u=>u.status==="delivered")&&await p(e,`parcels?id=eq.${a.parcel_id}`,{method:"PATCH",body:JSON.stringify({status:"delivered"})}),e.json({success:!0,transfer_number:r,outlet_code:a.outlet_code}))}catch(t){return console.error("Scan error:",t),e.json({error:"Scan failed"},500)}});_.post("/api/outlet/complete",y,async e=>{try{const t=e.get("user"),{outlet_code:r,signature_name:s}=await e.req.json();return await p(e,`parcels?outlet_code=eq.${r}&status=eq.delivered`,{method:"PATCH",body:JSON.stringify({delivered_at:new Date().toISOString(),delivered_by:t.id,scanned_unloading_by_name:t.full_name,received_by_name:s})}),e.json({success:!0})}catch{return e.json({error:"Failed to complete unloading"},500)}});_.get("/api/outlets",y,async e=>{try{const t=await p(e,"outlets?select=*&order=outlet_code.asc");if(!t.ok){const s=await t.text();return console.error("Supabase error:",s),e.json({error:"Failed to fetch outlets",details:s},500)}const r=await t.json();return console.log("Outlets fetched (v1.0.4):",Array.isArray(r)?r.length:"not an array"),e.json({outlets:Array.isArray(r)?r:[]})}catch(t){return console.error("Failed to fetch outlets exception:",t),e.json({error:"Failed to fetch outlets",message:String(t)},500)}});_.get("/api/v2/outlets",y,async e=>{try{const t=await p(e,"outlets?select=*&order=outlet_code.asc");if(!t.ok){const s=await t.text();return e.json({error:"Failed to fetch outlets",details:s},500)}const r=await t.json();return e.json({outlets:Array.isArray(r)?r:[],version:"1.0.4"})}catch(t){return e.json({error:"Failed to fetch outlets",message:String(t)},500)}});_.get("/api/parcels",y,async e=>{try{const r=await(await p(e,"parcels?select=outlet_code,outlet_code_short,outlet_name&order=outlet_code.asc")).json();return e.json({parcels:r})}catch(t){return console.error("Failed to fetch parcels:",t),e.json({error:"Failed to fetch parcels"},500)}});_.get("/api/containers/by-outlet/:outlet_code",y,async e=>{try{const t=e.get("user");let r=e.req.param("outlet_code");t.role==="outlet"&&t.outlet_code&&(r=t.outlet_code);const n=await(await p(e,`container_inventory?outlet_code=eq.${r}&status=eq.at_outlet&select=*&order=delivered_at.desc`)).json();return e.json({containers:n})}catch(t){return console.error("Failed to fetch containers:",t),e.json({error:"Failed to fetch containers"},500)}});_.get("/api/containers/inventory",y,async e=>{try{const t=e.get("user");if(!["admin","warehouse","warehouse_staff","warehouse_supervisor","outlet","driver"].includes(t.role))return e.json({error:"Forbidden"},403);let r="container_inventory?select=*&order=delivered_at.desc";t.role==="outlet"&&t.outlet_code&&(r=`container_inventory?outlet_code=eq.${t.outlet_code}&select=*&order=delivered_at.desc`);const n=await(await p(e,r)).json();return e.json({containers:n})}catch(t){return console.error("Failed to fetch container inventory:",t),e.json({error:"Failed to fetch container inventory"},500)}});_.post("/api/containers/scan-collect",y,async e=>{try{const t=e.get("user"),{container_id:r,outlet_code:s}=await e.req.json();console.log(`🔍 Scanning container ${r} for collection at outlet ${s}`);const o=await(await p(e,`container_inventory?container_id=eq.${r}&status=eq.at_outlet&select=*`)).json();if(!o||o.length===0)return console.log(`❌ Container ${r} not found in inventory`),e.json({success:!1,error:"Container not found or already collected",container_id:r});const a=o[0];return a.outlet_code!==s?(console.log(`⚠️ Container ${r} belongs to ${a.outlet_code}, not ${s}`),e.json({success:!1,cross_outlet:!0,error:`This container belongs to ${a.outlet_name} (${a.outlet_code})`,container_id:r,current_outlet:a.outlet_code,current_outlet_name:a.outlet_name,scanning_outlet:s})):(console.log(`✓ Container ${r} validated for collection`),e.json({success:!0,container_id:r,outlet_code:a.outlet_code,outlet_name:a.outlet_name,delivered_at:a.delivered_at}))}catch(t){return console.error("Container scan error:",t),e.json({error:"Scan failed"},500)}});_.post("/api/containers/collect-cross-outlet",y,async e=>{try{const t=e.get("user"),{container_id:r,scanning_outlet:s}=await e.req.json();console.log(`♻️ Cross-outlet collection: Container ${r} from ${s} by ${t.full_name}`);const o=await(await p(e,`container_inventory?container_id=eq.${r}&status=eq.at_outlet&select=*`)).json();if(!o||o.length===0)return e.json({success:!1,error:"Container not found or already collected",container_id:r});const a=o[0];return await p(e,`container_inventory?id=eq.${a.id}`,{method:"PATCH",body:JSON.stringify({status:"collected",collected_at:new Date().toISOString(),collected_by:t.id,collected_by_name:t.full_name})}),console.log(`✓ Container ${r} collected from ${a.outlet_code} (cross-outlet)`),e.json({success:!0,container_id:r,original_outlet:a.outlet_code,original_outlet_name:a.outlet_name,scanning_outlet:s})}catch(t){return console.error("Cross-outlet collection error:",t),e.json({error:"Collection failed"},500)}});_.post("/api/containers/complete-collection",y,async e=>{try{const t=e.get("user"),{outlet_code:r,container_ids:s,signature_name:n}=await e.req.json();if(console.log(`📦 Completing collection for outlet ${r}: ${s.length} containers by ${n}`),!s||s.length===0)return e.json({error:"No container IDs provided"},400);let o=0,a=0;const l=[];for(const i of s)try{const u=await(await p(e,`container_inventory?container_id=eq.${i}&outlet_code=eq.${r}&status=eq.at_outlet&select=*`)).json();if(!u||u.length===0){a++,l.push(`${i}: not found or already collected`);continue}const f=u[0];await p(e,`container_inventory?id=eq.${f.id}`,{method:"PATCH",body:JSON.stringify({status:"collected",collected_at:new Date().toISOString(),collected_by:t.id,collected_by_name:t.full_name,collection_signature:n})}),o++,console.log(`✓ Container ${i} collected from ${r}`)}catch(c){a++,l.push(`${i}: ${c instanceof Error?c.message:"unknown error"}`),console.error(`Error collecting container ${i}:`,c)}return console.log(`Collection complete: ${o} success, ${a} errors`),e.json({success:!0,total:s.length,success_count:o,error_count:a,errors:l.length>0?l:void 0,signature_name:n})}catch(t){return console.error("Complete collection error:",t),e.json({error:"Failed to complete collection"},500)}});_.get("/api/reports/deliveries",y,async e=>{try{const t=e.get("user"),{start_date:r,end_date:s,outlet_code:n}=e.req.query();let o="parcels?select=*&order=delivered_at.desc";t.role==="outlet"&&t.outlet_code?o+=`&outlet_code=eq.${t.outlet_code}`:n&&(o+=`&outlet_code=eq.${n}`),r&&(o+=`&delivered_at=gte.${r}`),s&&(o+=`&delivered_at=lte.${s}`);const l=await(await p(e,o)).json();return e.json({deliveries:l})}catch{return e.json({error:"Failed to fetch reports"},500)}});_.get("/api/reports/errors",y,async e=>{try{const t=e.get("user");let r="error_parcels?select=*&order=created_at.desc";t.role==="outlet"&&t.outlet_code&&(r+=`&outlet_code=eq.${t.outlet_code}`);const n=await(await p(e,r)).json();return e.json({errors:n})}catch{return e.json({error:"Failed to fetch errors"},500)}});_.get("/api/reports/audit",y,async e=>{try{const r=await(await p(e,"audit_logs?select=*&order=created_at.desc&limit=100")).json();return e.json({logs:r})}catch{return e.json({error:"Failed to fetch audit logs"},500)}});_.get("/",e=>e.html(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APD OASIS - Warehouse Logistic System</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .scan-input {
            border: 3px solid #3b82f6;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { border-color: #3b82f6; }
            50% { border-color: #60a5fa; }
        }
        .success-flash {
            animation: successFlash 0.5s;
        }
        @keyframes successFlash {
            0%, 100% { background-color: transparent; }
            50% { background-color: #10b981; }
        }
        .error-flash {
            animation: errorFlash 0.5s;
        }
        @keyframes errorFlash {
            0%, 100% { background-color: transparent; }
            50% { background-color: #ef4444; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"><\/script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"><\/script>
    <script src="/static/app.js"><\/script>
</body>
</html>
  `));const Qe=new $t,Xr=Object.assign({"/src/index.tsx":_});let Nt=!1;for(const[,e]of Object.entries(Xr))e&&(Qe.all("*",t=>{let r;try{r=t.executionCtx}catch{}return e.fetch(t.req.raw,t.env,r)}),Qe.notFound(t=>{let r;try{r=t.executionCtx}catch{}return e.fetch(t.req.raw,t.env,r)}),Nt=!0);if(!Nt)throw new Error("Can't import modules from ['/src/index.ts','/src/index.tsx','/app/server.ts']");export{Qe as default};
