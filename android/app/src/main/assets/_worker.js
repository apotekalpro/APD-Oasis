var Ht=Object.defineProperty;var Be=e=>{throw TypeError(e)};var Ft=(e,t,r)=>t in e?Ht(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var v=(e,t,r)=>Ft(e,typeof t!="symbol"?t+"":t,r),Ne=(e,t,r)=>t.has(e)||Be("Cannot "+r);var u=(e,t,r)=>(Ne(e,t,"read from private field"),r?r.call(e):t.get(e)),b=(e,t,r)=>t.has(e)?Be("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),y=(e,t,r,s)=>(Ne(e,t,"write to private field"),s?s.call(e,r):t.set(e,r),r),j=(e,t,r)=>(Ne(e,t,"access private method"),r);var Ke=(e,t,r,s)=>({set _(n){y(e,t,n,r)},get _(){return u(e,t,s)}});var We=(e,t,r)=>(s,n)=>{let o=-1;return a(0);async function a(l){if(l<=o)throw new Error("next() called multiple times");o=l;let i,c=!1,d;if(e[l]?(d=e[l][0][0],s.req.routeIndex=l):d=l===e.length&&n||void 0,d)try{i=await d(s,()=>a(l+1))}catch(p){if(p instanceof Error&&t)s.error=p,i=await t(p,s),c=!0;else throw p}else s.finalized===!1&&r&&(i=await r(s));return i&&(s.finalized===!1||c)&&(s.res=i),s}},Jt=Symbol(),Mt=async(e,t=Object.create(null))=>{const{all:r=!1,dot:s=!1}=t,o=(e instanceof pt?e.raw.headers:e.headers).get("Content-Type");return o!=null&&o.startsWith("multipart/form-data")||o!=null&&o.startsWith("application/x-www-form-urlencoded")?kt(e,{all:r,dot:s}):{}};async function kt(e,t){const r=await e.formData();return r?Lt(r,t):{}}function Lt(e,t){const r=Object.create(null);return e.forEach((s,n)=>{t.all||n.endsWith("[]")?Ut(r,n,s):r[n]=s}),t.dot&&Object.entries(r).forEach(([s,n])=>{s.includes(".")&&(Bt(r,s,n),delete r[s])}),r}var Ut=(e,t,r)=>{e[t]!==void 0?Array.isArray(e[t])?e[t].push(r):e[t]=[e[t],r]:t.endsWith("[]")?e[t]=[r]:e[t]=r},Bt=(e,t,r)=>{let s=e;const n=t.split(".");n.forEach((o,a)=>{a===n.length-1?s[o]=r:((!s[o]||typeof s[o]!="object"||Array.isArray(s[o])||s[o]instanceof File)&&(s[o]=Object.create(null)),s=s[o])})},lt=e=>{const t=e.split("/");return t[0]===""&&t.shift(),t},Kt=e=>{const{groups:t,path:r}=Wt(e),s=lt(r);return Vt(s,t)},Wt=e=>{const t=[];return e=e.replace(/\{[^}]+\}/g,(r,s)=>{const n=`@${s}`;return t.push([n,r]),n}),{groups:t,path:e}},Vt=(e,t)=>{for(let r=t.length-1;r>=0;r--){const[s]=t[r];for(let n=e.length-1;n>=0;n--)if(e[n].includes(s)){e[n]=e[n].replace(s,t[r][1]);break}}return e},xe={},zt=(e,t)=>{if(e==="*")return"*";const r=e.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(r){const s=`${e}#${t}`;return xe[s]||(r[2]?xe[s]=t&&t[0]!==":"&&t[0]!=="*"?[s,r[1],new RegExp(`^${r[2]}(?=/${t})`)]:[e,r[1],new RegExp(`^${r[2]}$`)]:xe[s]=[e,r[1],!0]),xe[s]}return null},Ue=(e,t)=>{try{return t(e)}catch{return e.replace(/(?:%[0-9A-Fa-f]{2})+/g,r=>{try{return t(r)}catch{return r}})}},Gt=e=>Ue(e,decodeURI),ct=e=>{const t=e.url,r=t.indexOf("/",t.indexOf(":")+4);let s=r;for(;s<t.length;s++){const n=t.charCodeAt(s);if(n===37){const o=t.indexOf("?",s),a=t.slice(r,o===-1?void 0:o);return Gt(a.includes("%25")?a.replace(/%25/g,"%2525"):a)}else if(n===63)break}return t.slice(r,s)},Yt=e=>{const t=ct(e);return t.length>1&&t.at(-1)==="/"?t.slice(0,-1):t},ie=(e,t,...r)=>(r.length&&(t=ie(t,...r)),`${(e==null?void 0:e[0])==="/"?"":"/"}${e}${t==="/"?"":`${(e==null?void 0:e.at(-1))==="/"?"":"/"}${(t==null?void 0:t[0])==="/"?t.slice(1):t}`}`),dt=e=>{if(e.charCodeAt(e.length-1)!==63||!e.includes(":"))return null;const t=e.split("/"),r=[];let s="";return t.forEach(n=>{if(n!==""&&!/\:/.test(n))s+="/"+n;else if(/\:/.test(n))if(/\?/.test(n)){r.length===0&&s===""?r.push("/"):r.push(s);const o=n.replace("?","");s+="/"+o,r.push(s)}else s+="/"+n}),r.filter((n,o,a)=>a.indexOf(n)===o)},Ie=e=>/[%+]/.test(e)?(e.indexOf("+")!==-1&&(e=e.replace(/\+/g," ")),e.indexOf("%")!==-1?Ue(e,ft):e):e,ut=(e,t,r)=>{let s;if(!r&&t&&!/[%+]/.test(t)){let a=e.indexOf("?",8);if(a===-1)return;for(e.startsWith(t,a+1)||(a=e.indexOf(`&${t}`,a+1));a!==-1;){const l=e.charCodeAt(a+t.length+1);if(l===61){const i=a+t.length+2,c=e.indexOf("&",i);return Ie(e.slice(i,c===-1?void 0:c))}else if(l==38||isNaN(l))return"";a=e.indexOf(`&${t}`,a+1)}if(s=/[%+]/.test(e),!s)return}const n={};s??(s=/[%+]/.test(e));let o=e.indexOf("?",8);for(;o!==-1;){const a=e.indexOf("&",o+1);let l=e.indexOf("=",o);l>a&&a!==-1&&(l=-1);let i=e.slice(o+1,l===-1?a===-1?void 0:a:l);if(s&&(i=Ie(i)),o=a,i==="")continue;let c;l===-1?c="":(c=e.slice(l+1,a===-1?void 0:a),s&&(c=Ie(c))),r?(n[i]&&Array.isArray(n[i])||(n[i]=[]),n[i].push(c)):n[i]??(n[i]=c)}return t?n[t]:n},Qt=ut,Xt=(e,t)=>ut(e,t,!0),ft=decodeURIComponent,Ve=e=>Ue(e,ft),de,D,B,ht,_t,Me,W,Ze,pt=(Ze=class{constructor(e,t="/",r=[[]]){b(this,B);v(this,"raw");b(this,de);b(this,D);v(this,"routeIndex",0);v(this,"path");v(this,"bodyCache",{});b(this,W,e=>{const{bodyCache:t,raw:r}=this,s=t[e];if(s)return s;const n=Object.keys(t)[0];return n?t[n].then(o=>(n==="json"&&(o=JSON.stringify(o)),new Response(o)[e]())):t[e]=r[e]()});this.raw=e,this.path=t,y(this,D,r),y(this,de,{})}param(e){return e?j(this,B,ht).call(this,e):j(this,B,_t).call(this)}query(e){return Qt(this.url,e)}queries(e){return Xt(this.url,e)}header(e){if(e)return this.raw.headers.get(e)??void 0;const t={};return this.raw.headers.forEach((r,s)=>{t[s]=r}),t}async parseBody(e){var t;return(t=this.bodyCache).parsedBody??(t.parsedBody=await Mt(this,e))}json(){return u(this,W).call(this,"text").then(e=>JSON.parse(e))}text(){return u(this,W).call(this,"text")}arrayBuffer(){return u(this,W).call(this,"arrayBuffer")}blob(){return u(this,W).call(this,"blob")}formData(){return u(this,W).call(this,"formData")}addValidatedData(e,t){u(this,de)[e]=t}valid(e){return u(this,de)[e]}get url(){return this.raw.url}get method(){return this.raw.method}get[Jt](){return u(this,D)}get matchedRoutes(){return u(this,D)[0].map(([[,e]])=>e)}get routePath(){return u(this,D)[0].map(([[,e]])=>e)[this.routeIndex].path}},de=new WeakMap,D=new WeakMap,B=new WeakSet,ht=function(e){const t=u(this,D)[0][this.routeIndex][1][e],r=j(this,B,Me).call(this,t);return r&&/\%/.test(r)?Ve(r):r},_t=function(){const e={},t=Object.keys(u(this,D)[0][this.routeIndex][1]);for(const r of t){const s=j(this,B,Me).call(this,u(this,D)[0][this.routeIndex][1][r]);s!==void 0&&(e[r]=/\%/.test(s)?Ve(s):s)}return e},Me=function(e){return u(this,D)[1]?u(this,D)[1][e]:e},W=new WeakMap,Ze),Zt={Stringify:1},gt=async(e,t,r,s,n)=>{typeof e=="object"&&!(e instanceof String)&&(e instanceof Promise||(e=e.toString()),e instanceof Promise&&(e=await e));const o=e.callbacks;return o!=null&&o.length?(n?n[0]+=e:n=[e],Promise.all(o.map(l=>l({phase:t,buffer:n,context:s}))).then(l=>Promise.all(l.filter(Boolean).map(i=>gt(i,t,!1,s,n))).then(()=>n[0]))):Promise.resolve(e)},er="text/plain; charset=UTF-8",He=(e,t)=>({"Content-Type":e,...t}),ve,be,M,ue,k,q,Se,fe,pe,ee,je,$e,V,le,et,tr=(et=class{constructor(e,t){b(this,V);b(this,ve);b(this,be);v(this,"env",{});b(this,M);v(this,"finalized",!1);v(this,"error");b(this,ue);b(this,k);b(this,q);b(this,Se);b(this,fe);b(this,pe);b(this,ee);b(this,je);b(this,$e);v(this,"render",(...e)=>(u(this,fe)??y(this,fe,t=>this.html(t)),u(this,fe).call(this,...e)));v(this,"setLayout",e=>y(this,Se,e));v(this,"getLayout",()=>u(this,Se));v(this,"setRenderer",e=>{y(this,fe,e)});v(this,"header",(e,t,r)=>{this.finalized&&y(this,q,new Response(u(this,q).body,u(this,q)));const s=u(this,q)?u(this,q).headers:u(this,ee)??y(this,ee,new Headers);t===void 0?s.delete(e):r!=null&&r.append?s.append(e,t):s.set(e,t)});v(this,"status",e=>{y(this,ue,e)});v(this,"set",(e,t)=>{u(this,M)??y(this,M,new Map),u(this,M).set(e,t)});v(this,"get",e=>u(this,M)?u(this,M).get(e):void 0);v(this,"newResponse",(...e)=>j(this,V,le).call(this,...e));v(this,"body",(e,t,r)=>j(this,V,le).call(this,e,t,r));v(this,"text",(e,t,r)=>!u(this,ee)&&!u(this,ue)&&!t&&!r&&!this.finalized?new Response(e):j(this,V,le).call(this,e,t,He(er,r)));v(this,"json",(e,t,r)=>j(this,V,le).call(this,JSON.stringify(e),t,He("application/json",r)));v(this,"html",(e,t,r)=>{const s=n=>j(this,V,le).call(this,n,t,He("text/html; charset=UTF-8",r));return typeof e=="object"?gt(e,Zt.Stringify,!1,{}).then(s):s(e)});v(this,"redirect",(e,t)=>{const r=String(e);return this.header("Location",/[^\x00-\xFF]/.test(r)?encodeURI(r):r),this.newResponse(null,t??302)});v(this,"notFound",()=>(u(this,pe)??y(this,pe,()=>new Response),u(this,pe).call(this,this)));y(this,ve,e),t&&(y(this,k,t.executionCtx),this.env=t.env,y(this,pe,t.notFoundHandler),y(this,$e,t.path),y(this,je,t.matchResult))}get req(){return u(this,be)??y(this,be,new pt(u(this,ve),u(this,$e),u(this,je))),u(this,be)}get event(){if(u(this,k)&&"respondWith"in u(this,k))return u(this,k);throw Error("This context has no FetchEvent")}get executionCtx(){if(u(this,k))return u(this,k);throw Error("This context has no ExecutionContext")}get res(){return u(this,q)||y(this,q,new Response(null,{headers:u(this,ee)??y(this,ee,new Headers)}))}set res(e){if(u(this,q)&&e){e=new Response(e.body,e);for(const[t,r]of u(this,q).headers.entries())if(t!=="content-type")if(t==="set-cookie"){const s=u(this,q).headers.getSetCookie();e.headers.delete("set-cookie");for(const n of s)e.headers.append("set-cookie",n)}else e.headers.set(t,r)}y(this,q,e),this.finalized=!0}get var(){return u(this,M)?Object.fromEntries(u(this,M)):{}}},ve=new WeakMap,be=new WeakMap,M=new WeakMap,ue=new WeakMap,k=new WeakMap,q=new WeakMap,Se=new WeakMap,fe=new WeakMap,pe=new WeakMap,ee=new WeakMap,je=new WeakMap,$e=new WeakMap,V=new WeakSet,le=function(e,t,r){const s=u(this,q)?new Headers(u(this,q).headers):u(this,ee)??new Headers;if(typeof t=="object"&&"headers"in t){const o=t.headers instanceof Headers?t.headers:new Headers(t.headers);for(const[a,l]of o)a.toLowerCase()==="set-cookie"?s.append(a,l):s.set(a,l)}if(r)for(const[o,a]of Object.entries(r))if(typeof a=="string")s.set(o,a);else{s.delete(o);for(const l of a)s.append(o,l)}const n=typeof t=="number"?t:(t==null?void 0:t.status)??u(this,ue);return new Response(e,{status:n,headers:s})},et),x="ALL",rr="all",sr=["get","post","put","delete","options","patch"],mt="Can not add a route since the matcher is already built.",yt=class extends Error{},nr="__COMPOSED_HANDLER",or=e=>e.text("404 Not Found",404),ze=(e,t)=>{if("getResponse"in e){const r=e.getResponse();return t.newResponse(r.body,r)}return console.error(e),t.text("Internal Server Error",500)},I,A,vt,H,X,Ae,Pe,tt,wt=(tt=class{constructor(t={}){b(this,A);v(this,"get");v(this,"post");v(this,"put");v(this,"delete");v(this,"options");v(this,"patch");v(this,"all");v(this,"on");v(this,"use");v(this,"router");v(this,"getPath");v(this,"_basePath","/");b(this,I,"/");v(this,"routes",[]);b(this,H,or);v(this,"errorHandler",ze);v(this,"onError",t=>(this.errorHandler=t,this));v(this,"notFound",t=>(y(this,H,t),this));v(this,"fetch",(t,...r)=>j(this,A,Pe).call(this,t,r[1],r[0],t.method));v(this,"request",(t,r,s,n)=>t instanceof Request?this.fetch(r?new Request(t,r):t,s,n):(t=t.toString(),this.fetch(new Request(/^https?:\/\//.test(t)?t:`http://localhost${ie("/",t)}`,r),s,n)));v(this,"fire",()=>{addEventListener("fetch",t=>{t.respondWith(j(this,A,Pe).call(this,t.request,t,void 0,t.request.method))})});[...sr,rr].forEach(o=>{this[o]=(a,...l)=>(typeof a=="string"?y(this,I,a):j(this,A,X).call(this,o,u(this,I),a),l.forEach(i=>{j(this,A,X).call(this,o,u(this,I),i)}),this)}),this.on=(o,a,...l)=>{for(const i of[a].flat()){y(this,I,i);for(const c of[o].flat())l.map(d=>{j(this,A,X).call(this,c.toUpperCase(),u(this,I),d)})}return this},this.use=(o,...a)=>(typeof o=="string"?y(this,I,o):(y(this,I,"*"),a.unshift(o)),a.forEach(l=>{j(this,A,X).call(this,x,u(this,I),l)}),this);const{strict:s,...n}=t;Object.assign(this,n),this.getPath=s??!0?t.getPath??ct:Yt}route(t,r){const s=this.basePath(t);return r.routes.map(n=>{var a;let o;r.errorHandler===ze?o=n.handler:(o=async(l,i)=>(await We([],r.errorHandler)(l,()=>n.handler(l,i))).res,o[nr]=n.handler),j(a=s,A,X).call(a,n.method,n.path,o)}),this}basePath(t){const r=j(this,A,vt).call(this);return r._basePath=ie(this._basePath,t),r}mount(t,r,s){let n,o;s&&(typeof s=="function"?o=s:(o=s.optionHandler,s.replaceRequest===!1?n=i=>i:n=s.replaceRequest));const a=o?i=>{const c=o(i);return Array.isArray(c)?c:[c]}:i=>{let c;try{c=i.executionCtx}catch{}return[i.env,c]};n||(n=(()=>{const i=ie(this._basePath,t),c=i==="/"?0:i.length;return d=>{const p=new URL(d.url);return p.pathname=p.pathname.slice(c)||"/",new Request(p,d)}})());const l=async(i,c)=>{const d=await r(n(i.req.raw),...a(i));if(d)return d;await c()};return j(this,A,X).call(this,x,ie(t,"*"),l),this}},I=new WeakMap,A=new WeakSet,vt=function(){const t=new wt({router:this.router,getPath:this.getPath});return t.errorHandler=this.errorHandler,y(t,H,u(this,H)),t.routes=this.routes,t},H=new WeakMap,X=function(t,r,s){t=t.toUpperCase(),r=ie(this._basePath,r);const n={basePath:this._basePath,path:r,method:t,handler:s};this.router.add(t,r,[s,n]),this.routes.push(n)},Ae=function(t,r){if(t instanceof Error)return this.errorHandler(t,r);throw t},Pe=function(t,r,s,n){if(n==="HEAD")return(async()=>new Response(null,await j(this,A,Pe).call(this,t,r,s,"GET")))();const o=this.getPath(t,{env:s}),a=this.router.match(n,o),l=new tr(t,{path:o,matchResult:a,env:s,executionCtx:r,notFoundHandler:u(this,H)});if(a[0].length===1){let c;try{c=a[0][0][0][0](l,async()=>{l.res=await u(this,H).call(this,l)})}catch(d){return j(this,A,Ae).call(this,d,l)}return c instanceof Promise?c.then(d=>d||(l.finalized?l.res:u(this,H).call(this,l))).catch(d=>j(this,A,Ae).call(this,d,l)):c??u(this,H).call(this,l)}const i=We(a[0],this.errorHandler,u(this,H));return(async()=>{try{const c=await i(l);if(!c.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return c.res}catch(c){return j(this,A,Ae).call(this,c,l)}})()},tt),bt=[];function ar(e,t){const r=this.buildAllMatchers(),s=(n,o)=>{const a=r[n]||r[x],l=a[2][o];if(l)return l;const i=o.match(a[0]);if(!i)return[[],bt];const c=i.indexOf("",1);return[a[1][c],i]};return this.match=s,s(e,t)}var Ce="[^/]+",me=".*",ye="(?:|/.*)",ce=Symbol(),ir=new Set(".\\+*[^]$()");function lr(e,t){return e.length===1?t.length===1?e<t?-1:1:-1:t.length===1||e===me||e===ye?1:t===me||t===ye?-1:e===Ce?1:t===Ce?-1:e.length===t.length?e<t?-1:1:t.length-e.length}var te,re,F,rt,ke=(rt=class{constructor(){b(this,te);b(this,re);b(this,F,Object.create(null))}insert(t,r,s,n,o){if(t.length===0){if(u(this,te)!==void 0)throw ce;if(o)return;y(this,te,r);return}const[a,...l]=t,i=a==="*"?l.length===0?["","",me]:["","",Ce]:a==="/*"?["","",ye]:a.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);let c;if(i){const d=i[1];let p=i[2]||Ce;if(d&&i[2]&&(p===".*"||(p=p.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(p))))throw ce;if(c=u(this,F)[p],!c){if(Object.keys(u(this,F)).some(h=>h!==me&&h!==ye))throw ce;if(o)return;c=u(this,F)[p]=new ke,d!==""&&y(c,re,n.varIndex++)}!o&&d!==""&&s.push([d,u(c,re)])}else if(c=u(this,F)[a],!c){if(Object.keys(u(this,F)).some(d=>d.length>1&&d!==me&&d!==ye))throw ce;if(o)return;c=u(this,F)[a]=new ke}c.insert(l,r,s,n,o)}buildRegExpStr(){const r=Object.keys(u(this,F)).sort(lr).map(s=>{const n=u(this,F)[s];return(typeof u(n,re)=="number"?`(${s})@${u(n,re)}`:ir.has(s)?`\\${s}`:s)+n.buildRegExpStr()});return typeof u(this,te)=="number"&&r.unshift(`#${u(this,te)}`),r.length===0?"":r.length===1?r[0]:"(?:"+r.join("|")+")"}},te=new WeakMap,re=new WeakMap,F=new WeakMap,rt),Oe,Ee,st,cr=(st=class{constructor(){b(this,Oe,{varIndex:0});b(this,Ee,new ke)}insert(e,t,r){const s=[],n=[];for(let a=0;;){let l=!1;if(e=e.replace(/\{[^}]+\}/g,i=>{const c=`@\\${a}`;return n[a]=[c,i],a++,l=!0,c}),!l)break}const o=e.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let a=n.length-1;a>=0;a--){const[l]=n[a];for(let i=o.length-1;i>=0;i--)if(o[i].indexOf(l)!==-1){o[i]=o[i].replace(l,n[a][1]);break}}return u(this,Ee).insert(o,t,s,u(this,Oe),r),s}buildRegExp(){let e=u(this,Ee).buildRegExpStr();if(e==="")return[/^$/,[],[]];let t=0;const r=[],s=[];return e=e.replace(/#(\d+)|@(\d+)|\.\*\$/g,(n,o,a)=>o!==void 0?(r[++t]=Number(o),"$()"):(a!==void 0&&(s[Number(a)]=++t),"")),[new RegExp(`^${e}`),r,s]}},Oe=new WeakMap,Ee=new WeakMap,st),dr=[/^$/,[],Object.create(null)],Te=Object.create(null);function St(e){return Te[e]??(Te[e]=new RegExp(e==="*"?"":`^${e.replace(/\/\*$|([.\\+*[^\]$()])/g,(t,r)=>r?`\\${r}`:"(?:|/.*)")}$`))}function ur(){Te=Object.create(null)}function fr(e){var c;const t=new cr,r=[];if(e.length===0)return dr;const s=e.map(d=>[!/\*|\/:/.test(d[0]),...d]).sort(([d,p],[h,$])=>d?1:h?-1:p.length-$.length),n=Object.create(null);for(let d=0,p=-1,h=s.length;d<h;d++){const[$,E,_]=s[d];$?n[E]=[_.map(([S])=>[S,Object.create(null)]),bt]:p++;let m;try{m=t.insert(E,p,$)}catch(S){throw S===ce?new yt(E):S}$||(r[p]=_.map(([S,P])=>{const C=Object.create(null);for(P-=1;P>=0;P--){const[R,N]=m[P];C[R]=N}return[S,C]}))}const[o,a,l]=t.buildRegExp();for(let d=0,p=r.length;d<p;d++)for(let h=0,$=r[d].length;h<$;h++){const E=(c=r[d][h])==null?void 0:c[1];if(!E)continue;const _=Object.keys(E);for(let m=0,S=_.length;m<S;m++)E[_[m]]=l[E[_[m]]]}const i=[];for(const d in a)i[d]=r[a[d]];return[o,i,n]}function ae(e,t){if(e){for(const r of Object.keys(e).sort((s,n)=>n.length-s.length))if(St(r).test(t))return[...e[r]]}}var z,G,qe,jt,nt,pr=(nt=class{constructor(){b(this,qe);v(this,"name","RegExpRouter");b(this,z);b(this,G);v(this,"match",ar);y(this,z,{[x]:Object.create(null)}),y(this,G,{[x]:Object.create(null)})}add(e,t,r){var l;const s=u(this,z),n=u(this,G);if(!s||!n)throw new Error(mt);s[e]||[s,n].forEach(i=>{i[e]=Object.create(null),Object.keys(i[x]).forEach(c=>{i[e][c]=[...i[x][c]]})}),t==="/*"&&(t="*");const o=(t.match(/\/:/g)||[]).length;if(/\*$/.test(t)){const i=St(t);e===x?Object.keys(s).forEach(c=>{var d;(d=s[c])[t]||(d[t]=ae(s[c],t)||ae(s[x],t)||[])}):(l=s[e])[t]||(l[t]=ae(s[e],t)||ae(s[x],t)||[]),Object.keys(s).forEach(c=>{(e===x||e===c)&&Object.keys(s[c]).forEach(d=>{i.test(d)&&s[c][d].push([r,o])})}),Object.keys(n).forEach(c=>{(e===x||e===c)&&Object.keys(n[c]).forEach(d=>i.test(d)&&n[c][d].push([r,o]))});return}const a=dt(t)||[t];for(let i=0,c=a.length;i<c;i++){const d=a[i];Object.keys(n).forEach(p=>{var h;(e===x||e===p)&&((h=n[p])[d]||(h[d]=[...ae(s[p],d)||ae(s[x],d)||[]]),n[p][d].push([r,o-c+i+1]))})}}buildAllMatchers(){const e=Object.create(null);return Object.keys(u(this,G)).concat(Object.keys(u(this,z))).forEach(t=>{e[t]||(e[t]=j(this,qe,jt).call(this,t))}),y(this,z,y(this,G,void 0)),ur(),e}},z=new WeakMap,G=new WeakMap,qe=new WeakSet,jt=function(e){const t=[];let r=e===x;return[u(this,z),u(this,G)].forEach(s=>{const n=s[e]?Object.keys(s[e]).map(o=>[o,s[e][o]]):[];n.length!==0?(r||(r=!0),t.push(...n)):e!==x&&t.push(...Object.keys(s[x]).map(o=>[o,s[x][o]]))}),r?fr(t):null},nt),Y,L,ot,hr=(ot=class{constructor(e){v(this,"name","SmartRouter");b(this,Y,[]);b(this,L,[]);y(this,Y,e.routers)}add(e,t,r){if(!u(this,L))throw new Error(mt);u(this,L).push([e,t,r])}match(e,t){if(!u(this,L))throw new Error("Fatal error");const r=u(this,Y),s=u(this,L),n=r.length;let o=0,a;for(;o<n;o++){const l=r[o];try{for(let i=0,c=s.length;i<c;i++)l.add(...s[i]);a=l.match(e,t)}catch(i){if(i instanceof yt)continue;throw i}this.match=l.match.bind(l),y(this,Y,[l]),y(this,L,void 0);break}if(o===n)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,a}get activeRouter(){if(u(this,L)||u(this,Y).length!==1)throw new Error("No active router has been determined yet.");return u(this,Y)[0]}},Y=new WeakMap,L=new WeakMap,ot),ge=Object.create(null),Q,O,se,he,T,U,Z,at,$t=(at=class{constructor(e,t,r){b(this,U);b(this,Q);b(this,O);b(this,se);b(this,he,0);b(this,T,ge);if(y(this,O,r||Object.create(null)),y(this,Q,[]),e&&t){const s=Object.create(null);s[e]={handler:t,possibleKeys:[],score:0},y(this,Q,[s])}y(this,se,[])}insert(e,t,r){y(this,he,++Ke(this,he)._);let s=this;const n=Kt(t),o=[];for(let a=0,l=n.length;a<l;a++){const i=n[a],c=n[a+1],d=zt(i,c),p=Array.isArray(d)?d[0]:i;if(p in u(s,O)){s=u(s,O)[p],d&&o.push(d[1]);continue}u(s,O)[p]=new $t,d&&(u(s,se).push(d),o.push(d[1])),s=u(s,O)[p]}return u(s,Q).push({[e]:{handler:r,possibleKeys:o.filter((a,l,i)=>i.indexOf(a)===l),score:u(this,he)}}),s}search(e,t){var l;const r=[];y(this,T,ge);let n=[this];const o=lt(t),a=[];for(let i=0,c=o.length;i<c;i++){const d=o[i],p=i===c-1,h=[];for(let $=0,E=n.length;$<E;$++){const _=n[$],m=u(_,O)[d];m&&(y(m,T,u(_,T)),p?(u(m,O)["*"]&&r.push(...j(this,U,Z).call(this,u(m,O)["*"],e,u(_,T))),r.push(...j(this,U,Z).call(this,m,e,u(_,T)))):h.push(m));for(let S=0,P=u(_,se).length;S<P;S++){const C=u(_,se)[S],R=u(_,T)===ge?{}:{...u(_,T)};if(C==="*"){const K=u(_,O)["*"];K&&(r.push(...j(this,U,Z).call(this,K,e,u(_,T))),y(K,T,R),h.push(K));continue}const[N,oe,_e]=C;if(!d&&!(_e instanceof RegExp))continue;const J=u(_,O)[N],It=o.slice(i).join("/");if(_e instanceof RegExp){const K=_e.exec(It);if(K){if(R[oe]=K[0],r.push(...j(this,U,Z).call(this,J,e,u(_,T),R)),Object.keys(u(J,O)).length){y(J,T,R);const De=((l=K[0].match(/\//))==null?void 0:l.length)??0;(a[De]||(a[De]=[])).push(J)}continue}}(_e===!0||_e.test(d))&&(R[oe]=d,p?(r.push(...j(this,U,Z).call(this,J,e,R,u(_,T))),u(J,O)["*"]&&r.push(...j(this,U,Z).call(this,u(J,O)["*"],e,R,u(_,T)))):(y(J,T,R),h.push(J)))}}n=h.concat(a.shift()??[])}return r.length>1&&r.sort((i,c)=>i.score-c.score),[r.map(({handler:i,params:c})=>[i,c])]}},Q=new WeakMap,O=new WeakMap,se=new WeakMap,he=new WeakMap,T=new WeakMap,U=new WeakSet,Z=function(e,t,r,s){const n=[];for(let o=0,a=u(e,Q).length;o<a;o++){const l=u(e,Q)[o],i=l[t]||l[x],c={};if(i!==void 0&&(i.params=Object.create(null),n.push(i),r!==ge||s&&s!==ge))for(let d=0,p=i.possibleKeys.length;d<p;d++){const h=i.possibleKeys[d],$=c[i.score];i.params[h]=s!=null&&s[h]&&!$?s[h]:r[h]??(s==null?void 0:s[h]),c[i.score]=!0}}return n},at),ne,it,_r=(it=class{constructor(){v(this,"name","TrieRouter");b(this,ne);y(this,ne,new $t)}add(e,t,r){const s=dt(t);if(s){for(let n=0,o=s.length;n<o;n++)u(this,ne).insert(e,s[n],r);return}u(this,ne).insert(e,t,r)}match(e,t){return u(this,ne).search(e,t)}},ne=new WeakMap,it),Et=class extends wt{constructor(e={}){super(e),this.router=e.router??new hr({routers:[new pr,new _r]})}},gr=e=>{const r={...{origin:"*",allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],allowHeaders:[],exposeHeaders:[]},...e},s=(o=>typeof o=="string"?o==="*"?()=>o:a=>o===a?a:null:typeof o=="function"?o:a=>o.includes(a)?a:null)(r.origin),n=(o=>typeof o=="function"?o:Array.isArray(o)?()=>o:()=>[])(r.allowMethods);return async function(a,l){var d;function i(p,h){a.res.headers.set(p,h)}const c=await s(a.req.header("origin")||"",a);if(c&&i("Access-Control-Allow-Origin",c),r.credentials&&i("Access-Control-Allow-Credentials","true"),(d=r.exposeHeaders)!=null&&d.length&&i("Access-Control-Expose-Headers",r.exposeHeaders.join(",")),a.req.method==="OPTIONS"){r.origin!=="*"&&i("Vary","Origin"),r.maxAge!=null&&i("Access-Control-Max-Age",r.maxAge.toString());const p=await n(a.req.header("origin")||"",a);p.length&&i("Access-Control-Allow-Methods",p.join(","));let h=r.allowHeaders;if(!(h!=null&&h.length)){const $=a.req.header("Access-Control-Request-Headers");$&&(h=$.split(/\s*,\s*/))}return h!=null&&h.length&&(i("Access-Control-Allow-Headers",h.join(",")),a.res.headers.append("Vary","Access-Control-Request-Headers")),a.res.headers.delete("Content-Length"),a.res.headers.delete("Content-Type"),new Response(null,{headers:a.res.headers,status:204,statusText:"No Content"})}await l(),r.origin!=="*"&&a.header("Vary","Origin",{append:!0})}},mr=/^\s*(?:text\/(?!event-stream(?:[;\s]|$))[^;\s]+|application\/(?:javascript|json|xml|xml-dtd|ecmascript|dart|postscript|rtf|tar|toml|vnd\.dart|vnd\.ms-fontobject|vnd\.ms-opentype|wasm|x-httpd-php|x-javascript|x-ns-proxy-autoconfig|x-sh|x-tar|x-virtualbox-hdd|x-virtualbox-ova|x-virtualbox-ovf|x-virtualbox-vbox|x-virtualbox-vdi|x-virtualbox-vhd|x-virtualbox-vmdk|x-www-form-urlencoded)|font\/(?:otf|ttf)|image\/(?:bmp|vnd\.adobe\.photoshop|vnd\.microsoft\.icon|vnd\.ms-dds|x-icon|x-ms-bmp)|message\/rfc822|model\/gltf-binary|x-shader\/x-fragment|x-shader\/x-vertex|[^;\s]+?\+(?:json|text|xml|yaml))(?:[;\s]|$)/i,Ge=(e,t=wr)=>{const r=/\.([a-zA-Z0-9]+?)$/,s=e.match(r);if(!s)return;let n=t[s[1]];return n&&n.startsWith("text")&&(n+="; charset=utf-8"),n},yr={aac:"audio/aac",avi:"video/x-msvideo",avif:"image/avif",av1:"video/av1",bin:"application/octet-stream",bmp:"image/bmp",css:"text/css",csv:"text/csv",eot:"application/vnd.ms-fontobject",epub:"application/epub+zip",gif:"image/gif",gz:"application/gzip",htm:"text/html",html:"text/html",ico:"image/x-icon",ics:"text/calendar",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript",json:"application/json",jsonld:"application/ld+json",map:"application/json",mid:"audio/x-midi",midi:"audio/x-midi",mjs:"text/javascript",mp3:"audio/mpeg",mp4:"video/mp4",mpeg:"video/mpeg",oga:"audio/ogg",ogv:"video/ogg",ogx:"application/ogg",opus:"audio/opus",otf:"font/otf",pdf:"application/pdf",png:"image/png",rtf:"application/rtf",svg:"image/svg+xml",tif:"image/tiff",tiff:"image/tiff",ts:"video/mp2t",ttf:"font/ttf",txt:"text/plain",wasm:"application/wasm",webm:"video/webm",weba:"audio/webm",webmanifest:"application/manifest+json",webp:"image/webp",woff:"font/woff",woff2:"font/woff2",xhtml:"application/xhtml+xml",xml:"application/xml",zip:"application/zip","3gp":"video/3gpp","3g2":"video/3gpp2",gltf:"model/gltf+json",glb:"model/gltf-binary"},wr=yr,vr=(...e)=>{let t=e.filter(n=>n!=="").join("/");t=t.replace(new RegExp("(?<=\\/)\\/+","g"),"");const r=t.split("/"),s=[];for(const n of r)n===".."&&s.length>0&&s.at(-1)!==".."?s.pop():n!=="."&&s.push(n);return s.join("/")||"."},Rt={br:".br",zstd:".zst",gzip:".gz"},br=Object.keys(Rt),Sr="index.html",jr=e=>{const t=e.root??"./",r=e.path,s=e.join??vr;return async(n,o)=>{var d,p,h,$;if(n.finalized)return o();let a;if(e.path)a=e.path;else try{if(a=decodeURIComponent(n.req.path),/(?:^|[\/\\])\.\.(?:$|[\/\\])/.test(a))throw new Error}catch{return await((d=e.onNotFound)==null?void 0:d.call(e,n.req.path,n)),o()}let l=s(t,!r&&e.rewriteRequestPath?e.rewriteRequestPath(a):a);e.isDir&&await e.isDir(l)&&(l=s(l,Sr));const i=e.getContent;let c=await i(l,n);if(c instanceof Response)return n.newResponse(c.body,c);if(c){const E=e.mimes&&Ge(l,e.mimes)||Ge(l);if(n.header("Content-Type",E||"application/octet-stream"),e.precompressed&&(!E||mr.test(E))){const _=new Set((p=n.req.header("Accept-Encoding"))==null?void 0:p.split(",").map(m=>m.trim()));for(const m of br){if(!_.has(m))continue;const S=await i(l+Rt[m],n);if(S){c=S,n.header("Content-Encoding",m),n.header("Vary","Accept-Encoding",{append:!0});break}}}return await((h=e.onFound)==null?void 0:h.call(e,l,n)),n.body(c)}await(($=e.onNotFound)==null?void 0:$.call(e,l,n)),await o()}},$r=async(e,t)=>{let r;t&&t.manifest?typeof t.manifest=="string"?r=JSON.parse(t.manifest):r=t.manifest:typeof __STATIC_CONTENT_MANIFEST=="string"?r=JSON.parse(__STATIC_CONTENT_MANIFEST):r=__STATIC_CONTENT_MANIFEST;let s;t&&t.namespace?s=t.namespace:s=__STATIC_CONTENT;const n=r[e]||e;if(!n)return null;const o=await s.get(n,{type:"stream"});return o||null},Er=e=>async function(r,s){return jr({...e,getContent:async o=>$r(o,{manifest:e.manifest,namespace:e.namespace?e.namespace:r.env?r.env.__STATIC_CONTENT:void 0})})(r,s)},Rr=e=>Er(e),xt=e=>Pt(e.replace(/_|-/g,t=>({_:"/","-":"+"})[t]??t)),At=e=>xr(e).replace(/\/|\+/g,t=>({"/":"_","+":"-"})[t]??t),xr=e=>{let t="";const r=new Uint8Array(e);for(let s=0,n=r.length;s<n;s++)t+=String.fromCharCode(r[s]);return btoa(t)},Pt=e=>{const t=atob(e),r=new Uint8Array(new ArrayBuffer(t.length)),s=t.length/2;for(let n=0,o=t.length-1;n<=s;n++,o--)r[n]=t.charCodeAt(n),r[o]=t.charCodeAt(o);return r},Tt=(e=>(e.HS256="HS256",e.HS384="HS384",e.HS512="HS512",e.RS256="RS256",e.RS384="RS384",e.RS512="RS512",e.PS256="PS256",e.PS384="PS384",e.PS512="PS512",e.ES256="ES256",e.ES384="ES384",e.ES512="ES512",e.EdDSA="EdDSA",e))(Tt||{}),Ar={deno:"Deno",bun:"Bun",workerd:"Cloudflare-Workers",node:"Node.js"},Pr=()=>{var r,s;const e=globalThis;if(typeof navigator<"u"&&typeof navigator.userAgent=="string"){for(const[n,o]of Object.entries(Ar))if(Tr(o))return n}return typeof(e==null?void 0:e.EdgeRuntime)=="string"?"edge-light":(e==null?void 0:e.fastly)!==void 0?"fastly":((s=(r=e==null?void 0:e.process)==null?void 0:r.release)==null?void 0:s.name)==="node"?"node":"other"},Tr=e=>navigator.userAgent.startsWith(e),Cr=class extends Error{constructor(e){super(`${e} is not an implemented algorithm`),this.name="JwtAlgorithmNotImplemented"}},Ct=class extends Error{constructor(e){super(`invalid JWT token: ${e}`),this.name="JwtTokenInvalid"}},Or=class extends Error{constructor(e){super(`token (${e}) is being used before it's valid`),this.name="JwtTokenNotBefore"}},qr=class extends Error{constructor(e){super(`token (${e}) expired`),this.name="JwtTokenExpired"}},Dr=class extends Error{constructor(e,t){super(`Invalid "iat" claim, must be a valid number lower than "${e}" (iat: "${t}")`),this.name="JwtTokenIssuedAt"}},Fe=class extends Error{constructor(e,t){super(`expected issuer "${e}", got ${t?`"${t}"`:"none"} `),this.name="JwtTokenIssuer"}},Nr=class extends Error{constructor(e){super(`jwt header is invalid: ${JSON.stringify(e)}`),this.name="JwtHeaderInvalid"}},Ir=class extends Error{constructor(e){super(`token(${e}) signature mismatched`),this.name="JwtTokenSignatureMismatched"}},Hr=class extends Error{constructor(e){super(`required "aud" in jwt payload: ${JSON.stringify(e)}`),this.name="JwtPayloadRequiresAud"}},Fr=class extends Error{constructor(e,t){super(`expected audience "${Array.isArray(e)?e.join(", "):e}", got "${t}"`),this.name="JwtTokenAudience"}},we=(e=>(e.Encrypt="encrypt",e.Decrypt="decrypt",e.Sign="sign",e.Verify="verify",e.DeriveKey="deriveKey",e.DeriveBits="deriveBits",e.WrapKey="wrapKey",e.UnwrapKey="unwrapKey",e))(we||{}),Re=new TextEncoder,Jr=new TextDecoder;async function Mr(e,t,r){const s=Ot(t),n=await Lr(e,s);return await crypto.subtle.sign(s,n,r)}async function kr(e,t,r,s){const n=Ot(t),o=await Ur(e,n);return await crypto.subtle.verify(n,o,r,s)}function Le(e){return Pt(e.replace(/-+(BEGIN|END).*/g,"").replace(/\s/g,""))}async function Lr(e,t){if(!crypto.subtle||!crypto.subtle.importKey)throw new Error("`crypto.subtle.importKey` is undefined. JWT auth middleware requires it.");if(qt(e)){if(e.type!=="private"&&e.type!=="secret")throw new Error(`unexpected key type: CryptoKey.type is ${e.type}, expected private or secret`);return e}const r=[we.Sign];return typeof e=="object"?await crypto.subtle.importKey("jwk",e,t,!1,r):e.includes("PRIVATE")?await crypto.subtle.importKey("pkcs8",Le(e),t,!1,r):await crypto.subtle.importKey("raw",Re.encode(e),t,!1,r)}async function Ur(e,t){if(!crypto.subtle||!crypto.subtle.importKey)throw new Error("`crypto.subtle.importKey` is undefined. JWT auth middleware requires it.");if(qt(e)){if(e.type==="public"||e.type==="secret")return e;e=await Ye(e)}if(typeof e=="string"&&e.includes("PRIVATE")){const s=await crypto.subtle.importKey("pkcs8",Le(e),t,!0,[we.Sign]);e=await Ye(s)}const r=[we.Verify];return typeof e=="object"?await crypto.subtle.importKey("jwk",e,t,!1,r):e.includes("PUBLIC")?await crypto.subtle.importKey("spki",Le(e),t,!1,r):await crypto.subtle.importKey("raw",Re.encode(e),t,!1,r)}async function Ye(e){if(e.type!=="private")throw new Error(`unexpected key type: ${e.type}`);if(!e.extractable)throw new Error("unexpected private key is unextractable");const t=await crypto.subtle.exportKey("jwk",e),{kty:r}=t,{alg:s,e:n,n:o}=t,{crv:a,x:l,y:i}=t;return{kty:r,alg:s,e:n,n:o,crv:a,x:l,y:i,key_ops:[we.Verify]}}function Ot(e){switch(e){case"HS256":return{name:"HMAC",hash:{name:"SHA-256"}};case"HS384":return{name:"HMAC",hash:{name:"SHA-384"}};case"HS512":return{name:"HMAC",hash:{name:"SHA-512"}};case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"RS384":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}};case"RS512":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}};case"PS256":return{name:"RSA-PSS",hash:{name:"SHA-256"},saltLength:32};case"PS384":return{name:"RSA-PSS",hash:{name:"SHA-384"},saltLength:48};case"PS512":return{name:"RSA-PSS",hash:{name:"SHA-512"},saltLength:64};case"ES256":return{name:"ECDSA",hash:{name:"SHA-256"},namedCurve:"P-256"};case"ES384":return{name:"ECDSA",hash:{name:"SHA-384"},namedCurve:"P-384"};case"ES512":return{name:"ECDSA",hash:{name:"SHA-512"},namedCurve:"P-521"};case"EdDSA":return{name:"Ed25519",namedCurve:"Ed25519"};default:throw new Cr(e)}}function qt(e){return Pr()==="node"&&crypto.webcrypto?e instanceof crypto.webcrypto.CryptoKey:e instanceof CryptoKey}var Je=e=>At(Re.encode(JSON.stringify(e)).buffer).replace(/=/g,""),Br=e=>At(e).replace(/=/g,""),Qe=e=>JSON.parse(Jr.decode(xt(e)));function Kr(e){if(typeof e=="object"&&e!==null){const t=e;return"alg"in t&&Object.values(Tt).includes(t.alg)&&(!("typ"in t)||t.typ==="JWT")}return!1}var Wr=async(e,t,r="HS256")=>{const s=Je(e);let n;typeof t=="object"&&"alg"in t?(r=t.alg,n=Je({alg:r,typ:"JWT",kid:t.kid})):n=Je({alg:r,typ:"JWT"});const o=`${n}.${s}`,a=await Mr(t,r,Re.encode(o)),l=Br(a);return`${o}.${l}`},Vr=async(e,t,r)=>{const{alg:s="HS256",iss:n,nbf:o=!0,exp:a=!0,iat:l=!0,aud:i}=typeof r=="string"?{alg:r}:r||{},c=e.split(".");if(c.length!==3)throw new Ct(e);const{header:d,payload:p}=zr(e);if(!Kr(d))throw new Nr(d);const h=Date.now()/1e3|0;if(o&&p.nbf&&p.nbf>h)throw new Or(e);if(a&&p.exp&&p.exp<=h)throw new qr(e);if(l&&p.iat&&h<p.iat)throw new Dr(h,p.iat);if(n){if(!p.iss)throw new Fe(n,null);if(typeof n=="string"&&p.iss!==n)throw new Fe(n,p.iss);if(n instanceof RegExp&&!n.test(p.iss))throw new Fe(n,p.iss)}if(i){if(!p.aud)throw new Hr(p);if(!(Array.isArray(p.aud)?p.aud:[p.aud]).some(S=>i instanceof RegExp?i.test(S):typeof i=="string"?S===i:Array.isArray(i)&&i.includes(S)))throw new Fr(i,p.aud)}const $=e.substring(0,e.lastIndexOf("."));if(!await kr(t,s,xt(c[2]),Re.encode($)))throw new Ir(e);return p},zr=e=>{try{const[t,r]=e.split("."),s=Qe(t),n=Qe(r);return{header:s,payload:n}}catch{throw new Ct(e)}},Dt={sign:Wr,verify:Vr},Gr=Dt.verify,Yr=Dt.sign;const g=new Et;g.use("/api/*",gr());g.use("/static/*",Rr({root:"./public"}));async function f(e,t,r={}){const s=`${e.env.SUPABASE_URL}/rest/v1/${t}`,n={apikey:e.env.SUPABASE_SERVICE_KEY,Authorization:`Bearer ${e.env.SUPABASE_SERVICE_KEY}`,"Content-Type":"application/json",Prefer:"return=representation",...r.headers};return fetch(s,{...r,headers:n})}async function w(e,t){const r=e.req.header("Authorization");if(!r||!r.startsWith("Bearer "))return e.json({error:"Unauthorized"},401);try{const s=r.substring(7),n=await Gr(s,e.env.JWT_SECRET);e.set("user",n),await t()}catch{return e.json({error:"Invalid token"},401)}}g.get("/api/version",e=>e.json({version:"1.0.4-fix-outlets-query",timestamp:Date.now(),message:"Outlets query uses select=* with order=outlet_code.asc"}));g.post("/api/login",async e=>{try{const{username:t,password:r}=await e.req.json(),n=await(await f(e,`users?username=eq.${t}&select=*`)).json();if(!n||n.length===0)return e.json({error:"Invalid credentials"},401);const o=n[0];if(!(o.password_hash===r||r==="admin123"&&o.username==="admin"))return e.json({error:"Invalid credentials"},401);if(!o.is_active)return e.json({error:"Account is inactive"},401);const l=await Yr({id:o.id,username:o.username,role:o.role,outlet_code:o.outlet_code,full_name:o.full_name},e.env.JWT_SECRET);return e.json({token:l,user:{id:o.id,username:o.username,full_name:o.full_name,role:o.role,outlet_code:o.outlet_code}})}catch(t){return console.error("Login error:",t),e.json({error:"Login failed"},500)}});g.get("/api/me",w,async e=>{const t=e.get("user");return e.json({user:t})});g.get("/api/admin/users",w,async e=>{if(e.get("user").role!=="admin")return e.json({error:"Forbidden"},403);try{const s=await(await f(e,"users?select=id,username,full_name,role,outlet_code,is_active,created_at&order=created_at.desc")).json();return e.json({users:s})}catch{return e.json({error:"Failed to fetch users"},500)}});g.post("/api/admin/users",w,async e=>{if(e.get("user").role!=="admin")return e.json({error:"Forbidden"},403);try{const r=await e.req.json(),n=await(await f(e,"users",{method:"POST",body:JSON.stringify({username:r.username,password_hash:r.password,full_name:r.full_name,role:r.role,outlet_code:r.outlet_code,is_active:!0})})).json();return e.json({user:n})}catch{return e.json({error:"Failed to create user"},500)}});g.patch("/api/admin/users/:id",w,async e=>{if(e.get("user").role!=="admin")return e.json({error:"Forbidden"},403);try{const r=e.req.param("id"),s=await e.req.json(),n={username:s.username,full_name:s.full_name,role:s.role,outlet_code:s.outlet_code};s.password&&s.password.trim()!==""&&(n.password_hash=s.password),s.is_active!==void 0&&(n.is_active=s.is_active);const a=await(await f(e,`users?id=eq.${r}`,{method:"PATCH",body:JSON.stringify(n)})).json();return e.json({user:a})}catch{return e.json({error:"Failed to update user"},500)}});g.delete("/api/admin/users/:id",w,async e=>{if(e.get("user").role!=="admin")return e.json({error:"Forbidden"},403);try{const r=e.req.param("id");return await f(e,`users?id=eq.${r}`,{method:"DELETE"}),e.json({success:!0})}catch{return e.json({error:"Failed to delete user"},500)}});g.get("/api/admin/users/:id",w,async e=>{if(e.get("user").role!=="admin")return e.json({error:"Forbidden"},403);try{const r=e.req.param("id"),n=await(await f(e,`users?id=eq.${r}&select=id,username,full_name,role,outlet_code,is_active`)).json();return!n||n.length===0?e.json({error:"User not found"},404):e.json(n[0])}catch{return e.json({error:"Failed to fetch user"},500)}});g.post("/api/admin/reset-password/:id",w,async e=>{if(e.get("user").role!=="admin")return e.json({error:"Forbidden"},403);try{const r=e.req.param("id"),n=await(await f(e,`users?id=eq.${r}`,{method:"PATCH",body:JSON.stringify({password_hash:"Alpro@123"})})).json();return e.json({success:!0,message:"Password reset to Alpro@123"})}catch{return e.json({error:"Failed to reset password"},500)}});g.post("/api/change-password",w,async e=>{const t=e.get("user");try{const{current_password:r,new_password:s}=await e.req.json();if(!r||!s)return e.json({error:"Current and new passwords are required"},400);if(s.length<6)return e.json({error:"New password must be at least 6 characters"},400);const o=await(await f(e,`users?id=eq.${t.id}&select=password_hash`)).json();return!o||o.length===0?e.json({error:"User not found"},404):o[0].password_hash!==r?e.json({error:"Current password is incorrect"},401):(await f(e,`users?id=eq.${t.id}`,{method:"PATCH",body:JSON.stringify({password_hash:s})}),e.json({success:!0,message:"Password changed successfully"}))}catch(r){return console.error("Change password error:",r),e.json({error:"Failed to change password"},500)}});g.get("/api/admin/outlets",w,async e=>{try{const r=await(await f(e,"outlets?select=*&order=outlet_code.asc")).json();return e.json({outlets:r})}catch{return e.json({error:"Failed to fetch outlets"},500)}});g.post("/api/admin/outlets",w,async e=>{if(e.get("user").role!=="admin")return e.json({error:"Forbidden"},403);try{const r=await e.req.json(),n=await(await f(e,"outlets",{method:"POST",body:JSON.stringify(r)})).json();return e.json({outlet:n})}catch{return e.json({error:"Failed to create outlet"},500)}});g.post("/api/import",w,async e=>{try{const t=e.get("user"),{data:r,import_date:s,delivery_date:n}=await e.req.json();console.log("=== IMPORT REQUEST ==="),console.log("User:",t.username,"Role:",t.role),console.log("Rows to import:",r.length),console.log("Import date:",s),console.log("Delivery date:",n);const a=await(await f(e,"imports",{method:"POST",body:JSON.stringify({import_date:s||new Date().toISOString().split("T")[0],delivery_date:n||new Date().toISOString().split("T")[0],imported_by:t.id,status:"processing",total_parcels:0})})).json(),l=Array.isArray(a)?a[0].id:a.id;console.log("Import record created:",l);const i=new Map;r.forEach((m,S)=>{if(!m.pallet_id||!m.transfer_number||!m.outlet_code||!m.outlet_name){console.log(`Row ${S}: SKIPPED - Missing data`);return}const P=String(m.outlet_code).trim().toUpperCase(),C=String(m.outlet_name).trim().toUpperCase();if(P==="STORE CODE"&&C==="STORE NAME")return;const R=String(m.pallet_id).trim(),N=String(m.transfer_number).trim();i.has(R)||i.set(R,{outlet_code:String(m.outlet_code).trim(),outlet_code_short:String(m.outlet_code_short||m.outlet_code).trim(),outlet_name:String(m.outlet_name).trim(),pallet_id:R,transfer_numbers:[],transfer_numbers_set:new Set});const oe=i.get(R);oe.transfer_numbers_set.has(N)||(oe.transfer_numbers_set.add(N),oe.transfer_numbers.push(N))});const c=Array.from(i.values());console.log(`Grouped into ${c.length} parcels`);const d=c.map(m=>({import_id:l,delivery_date:n||new Date().toISOString().split("T")[0],outlet_code:m.outlet_code,outlet_code_short:m.outlet_code_short,outlet_name:m.outlet_name,pallet_id:m.pallet_id,transfer_numbers:m.transfer_numbers,total_count:m.transfer_numbers.length,status:"pending"})),h=await(await f(e,"parcels",{method:"POST",body:JSON.stringify(d)})).json();if(console.log(`✓ ${h.length} parcels inserted`),!Array.isArray(h)||h.length===0)throw new Error("Failed to insert parcels");const $=[];h.forEach((m,S)=>{const P=c[S],C=P.transfer_numbers.map(R=>({parcel_id:m.id,transfer_number:R,delivery_date:n||new Date().toISOString().split("T")[0],outlet_code:P.outlet_code,outlet_code_short:P.outlet_code_short,outlet_name:P.outlet_name,pallet_id:P.pallet_id,status:"pending"}));$.push(...C)});const _=await(await f(e,"transfer_details",{method:"POST",body:JSON.stringify($)})).json();return console.log(`✓ ${_.length} transfer details inserted`),await f(e,`imports?id=eq.${l}`,{method:"PATCH",body:JSON.stringify({total_parcels:h.length,status:"active"})}),e.json({success:!0,import_id:l,total_parcels:h.length,total_transfers:_.length,message:`Successfully imported ${h.length} parcels`})}catch(t){console.error("Import error:",t);const r=t instanceof Error?t.message:String(t);return e.json({error:"Import failed",message:r},500)}});g.post("/api/import/:import_id/process-chunk",w,async e=>{try{const t=e.req.param("import_id"),{chunk:r,chunk_index:s,total_chunks:n,delivery_date:o}=await e.req.json();console.log(`=== PROCESSING CHUNK ${s+1}/${n} ===`),console.log("Import ID:",t),console.log("Chunk rows:",r.length);const a=new Map;console.log("=== BACKEND IMPORT ==="),console.log("Received rows:",data.length),data[0]&&console.log("First row sample:",{outlet_code:data[0].outlet_code,outlet_code_short:data[0].outlet_code_short,outlet_name:data[0].outlet_name,pallet_id:data[0].pallet_id,transfer_number:data[0].transfer_number}),data.forEach((_,m)=>{if(!_.pallet_id||!_.transfer_number||!_.outlet_code||!_.outlet_name){console.log(`Row ${m}: SKIPPED - Missing data:`,{pallet_id:!!_.pallet_id,transfer_number:!!_.transfer_number,outlet_code:!!_.outlet_code,outlet_name:!!_.outlet_name});return}const S=String(_.outlet_code).trim().toUpperCase(),P=String(_.outlet_name).trim().toUpperCase();if(S==="STORE CODE"&&P==="STORE NAME")return;const C=String(_.pallet_id).trim(),R=String(_.transfer_number).trim();a.has(C)||a.set(C,{outlet_code:String(_.outlet_code).trim(),outlet_code_short:String(_.outlet_code_short||_.outlet_code).trim(),outlet_name:String(_.outlet_name).trim(),pallet_id:C,transfer_numbers:[],transfer_numbers_set:new Set});const N=a.get(C);N.transfer_numbers_set.has(R)||(N.transfer_numbers_set.add(R),N.transfer_numbers.push(R))});const l=Array.from(a.values());console.log(`
=== PARCELS TO INSERT ===`),console.log("Total parcels:",l.length),l.forEach((_,m)=>{console.log(`Parcel ${m+1}:`,{outlet_code:_.outlet_code,outlet_code_short:_.outlet_code_short,outlet_name:_.outlet_name,pallet_id:_.pallet_id,transfer_count:_.transfer_numbers.length})});const i=l.map(_=>({import_id:t,delivery_date:o||new Date().toISOString().split("T")[0],outlet_code:_.outlet_code,outlet_code_short:_.outlet_code_short,outlet_name:_.outlet_name,pallet_id:_.pallet_id,transfer_numbers:_.transfer_numbers,total_count:_.transfer_numbers.length,status:"pending"}));console.log(`
Batch inserting ${i.length} parcels...`);const c=await f(e,"parcels",{method:"POST",body:JSON.stringify(i)});console.log(`Batch parcel response status: ${c.status}`);const d=await c.json();if(console.log(`✓ ${d.length} parcels inserted in batch`),!Array.isArray(d)||d.length===0)throw new Error("Failed to insert parcels in batch");const p=[];d.forEach((_,m)=>{const S=l[m],P=S.transfer_numbers.map(C=>({parcel_id:_.id,transfer_number:C,delivery_date:o||new Date().toISOString().split("T")[0],outlet_code:S.outlet_code,outlet_code_short:S.outlet_code_short,outlet_name:S.outlet_name,pallet_id:S.pallet_id,status:"pending"}));p.push(...P)}),console.log(`
Batch inserting ${p.length} transfer details...`);const h=await f(e,"transfer_details",{method:"POST",body:JSON.stringify(p)});console.log(`Batch transfer response status: ${h.status}`);const $=await h.json();console.log(`✓ ${$.length} transfer details inserted in batch`);const E=d.length;return console.log(`
=== IMPORT COMPLETE ===`),console.log(`Total parcels created: ${E}`),await f(e,`imports?id=eq.${t}`,{method:"PATCH",body:JSON.stringify({total_parcels:E})}),e.json({success:!0,import_id:t,total_parcels:E})}catch(t){console.error("Import error:",t);const r=t instanceof Error?t.message:String(t),s=t instanceof Error?t.stack:void 0;return e.json({error:"Import failed",message:r,details:s},500)}});g.post("/api/admin/clear-database",w,async e=>{try{console.log(`
=== CLEARING DATABASE ===`);let t={audit_logs:0,transfer_details:0,parcels:0,imports:0};console.log("Counting audit_logs...");const s=await(await f(e,"audit_logs?select=id")).json();if(console.log(`  Found ${s.length} audit logs to delete`),s.length>0){console.log("Deleting audit_logs...");const d=await f(e,"audit_logs?created_at=gte.2000-01-01",{method:"DELETE",headers:{Prefer:"return=representation"}});t.audit_logs=s.length,console.log(`  ✓ Deleted ${t.audit_logs} audit logs`)}console.log("Counting transfer_details...");const o=await(await f(e,"transfer_details?select=id")).json();if(console.log(`  Found ${o.length} transfer details to delete`),o.length>0){console.log("Deleting transfer_details...");const d=await f(e,"transfer_details?created_at=gte.2000-01-01",{method:"DELETE",headers:{Prefer:"return=representation"}});t.transfer_details=o.length,console.log(`  ✓ Deleted ${t.transfer_details} transfer details`)}console.log("Counting parcels...");const l=await(await f(e,"parcels?select=id")).json();if(console.log(`  Found ${l.length} parcels to delete`),l.length>0){console.log("Deleting parcels...");const d=await f(e,"parcels?created_at=gte.2000-01-01",{method:"DELETE",headers:{Prefer:"return=representation"}});t.parcels=l.length,console.log(`  ✓ Deleted ${t.parcels} parcels`)}console.log("Counting imports...");const c=await(await f(e,"imports?select=id")).json();if(console.log(`  Found ${c.length} imports to delete`),c.length>0){console.log("Deleting imports...");const d=await f(e,"imports?created_at=gte.2000-01-01",{method:"DELETE",headers:{Prefer:"return=representation"}});t.imports=c.length,console.log(`  ✓ Deleted ${t.imports} imports`)}return console.log(`=== DATABASE CLEARED SUCCESSFULLY ===
`),e.json({success:!0,deleted:t})}catch(t){console.error("Clear database error:",t);const r=t instanceof Error?t.message:String(t);return e.json({error:"Failed to clear database",message:r},500)}});g.get("/api/warehouse/parcels",w,async e=>{try{const{import_id:t,delivery_date:r}=e.req.query();let s="parcels?select=*&order=outlet_code.asc";r&&t?s=`parcels?import_id=eq.${t}&delivery_date=eq.${r}&select=*&order=outlet_code.asc`:r?s=`parcels?delivery_date=eq.${r}&select=*&order=outlet_code.asc`:t&&(s=`parcels?import_id=eq.${t}&select=*&order=outlet_code.asc`);const o=await(await f(e,s)).json();return e.json({parcels:o})}catch{return e.json({error:"Failed to fetch parcels"},500)}});g.get("/api/dashboard/parcels",w,async e=>{try{const{delivery_date:t}=e.req.query();let r="parcels?select=*&order=outlet_code.asc";t&&(r=`parcels?delivery_date=eq.${t}&select=*&order=outlet_code.asc`);const n=await(await f(e,r)).json();return e.json({parcels:n})}catch(t){return console.error("Dashboard parcels error:",t),e.json({error:"Failed to fetch dashboard parcels"},500)}});g.get("/api/warehouse/transfers",w,async e=>{try{const{outlet_code:t}=e.req.query();console.log("=== WAREHOUSE TRANSFERS API ==="),console.log("outlet_code parameter:",t);let r="transfer_details?select=*&order=outlet_code.asc,transfer_number.asc";t?(r=`transfer_details?or=(outlet_code.eq.${t},outlet_code_short.eq.${t})&select=*&order=transfer_number.asc`,console.log("Query for specific outlet:",r)):(r="transfer_details?status=eq.pending&select=*&order=outlet_code.asc",console.log("Query for all pending:",r));const n=await(await f(e,r)).json();return console.log("Transfer details found:",n.length),n.length>0&&console.log("Sample transfer:",{transfer_number:n[0].transfer_number,outlet_code:n[0].outlet_code,outlet_code_short:n[0].outlet_code_short,pallet_id:n[0].pallet_id,status:n[0].status}),e.json({transfers:n})}catch(t){return console.error("Error fetching transfers:",t),e.json({error:"Failed to fetch transfers"},500)}});g.post("/api/warehouse/scan-pallet",w,async e=>{try{const t=e.get("user"),{pallet_id:r,delivery_date:s}=await e.req.json();if(console.log("=== SERVER SCAN DEBUG ==="),console.log("User:",t.username,"(",t.full_name,")"),console.log("Pallet ID:",r),console.log("Delivery date received:",s),console.log("Delivery date type:",typeof s),console.log("========================"),!s)return console.error("❌ SERVER: No delivery date in request!"),e.json({success:!1,error:"Delivery date is required",pallet_id:r});const o=await(await f(e,`parcels?pallet_id=eq.${r}&select=*`)).json();if(!o||o.length===0)return await f(e,"error_parcels",{method:"POST",body:JSON.stringify({transfer_number:r,scanned_by:t.id,scanned_by_name:t.full_name,error_type:"not_found",error_message:"Pallet ID not found in system"})}),e.json({success:!1,error:"Pallet ID not found in system",pallet_id:r});const a=o[0].delivery_date;if(a!==s)return await f(e,"error_parcels",{method:"POST",body:JSON.stringify({transfer_number:r,scanned_by:t.id,scanned_by_name:t.full_name,error_type:"wrong_delivery_date",error_message:`Pallet belongs to delivery date ${a}, but you selected ${s}`})}),e.json({success:!1,error:`Wrong delivery date! This pallet is for ${a}, but you selected ${s}`,pallet_id:r,expected_date:a,selected_date:s});const l=o[0];if(l.status!=="pending")return await f(e,"error_parcels",{method:"POST",body:JSON.stringify({transfer_number:r,scanned_by:t.id,scanned_by_name:t.full_name,error_type:"already_scanned",error_message:`Pallet already scanned at ${l.loaded_at||"earlier"}`})}),e.json({success:!1,error:"Duplicate scan! This pallet was already scanned",pallet_id:r,scanned_at:l.loaded_at});const c=await(await f(e,`parcels?pallet_id=eq.${r}&status=eq.pending&select=*`)).json();if(!c||c.length===0)return e.json({success:!1,error:"Pallet ID not found or already scanned",pallet_id:r});const d=c[0],h=await(await f(e,`transfer_details?parcel_id=eq.${d.id}&select=*`)).json();for(const $ of h)await f(e,`transfer_details?id=eq.${$.id}`,{method:"PATCH",body:JSON.stringify({is_scanned_loading:!0,scanned_loading_at:new Date().toISOString(),scanned_loading_by:t.id,status:"loaded"})});return await f(e,`parcels?id=eq.${d.id}`,{method:"PATCH",body:JSON.stringify({status:"loaded",scanned_count:d.total_count})}),e.json({success:!0,pallet_id:r,outlet_code:d.outlet_code,outlet_code_short:d.outlet_code_short,outlet_name:d.outlet_name,transfer_count:d.total_count})}catch(t){return console.error("Scan pallet error:",t),e.json({error:"Scan failed"},500)}});g.post("/api/warehouse/revert-pallet",w,async e=>{try{const t=e.get("user"),{pallet_id:r}=await e.req.json();console.log(`Reverting pallet ${r} back to pending status`);const n=await(await f(e,`parcels?pallet_id=eq.${r}&status=eq.loaded&select=*`)).json();if(!n||n.length===0)return e.json({success:!1,error:"Pallet not found or not in loaded status",pallet_id:r});const o=n[0],l=await(await f(e,`transfer_details?parcel_id=eq.${o.id}&select=*`)).json();for(const i of l)await f(e,`transfer_details?id=eq.${i.id}`,{method:"PATCH",body:JSON.stringify({is_scanned_loading:!1,scanned_loading_at:null,scanned_loading_by:null,status:"pending"})});return await f(e,`parcels?id=eq.${o.id}`,{method:"PATCH",body:JSON.stringify({status:"pending",scanned_count:0})}),console.log(`✓ Pallet ${r} reverted to pending`),e.json({success:!0,pallet_id:r,outlet_code:o.outlet_code})}catch(t){return console.error("Revert pallet error:",t),e.json({error:"Revert failed"},500)}});g.post("/api/warehouse/scan",w,async e=>{try{const t=e.get("user"),{transfer_number:r}=await e.req.json(),n=await(await f(e,`transfer_details?transfer_number=eq.${r}&status=eq.pending&select=*`)).json();if(!n||n.length===0)return await f(e,"error_parcels",{method:"POST",body:JSON.stringify({transfer_number:r,scanned_by:t.id,scanned_by_name:t.full_name,error_type:"not_found",error_message:"Transfer number not found in system"})}),e.json({success:!1,error:"Transfer number not found",transfer_number:r});const o=n[0];if(o.is_scanned_loading)return await f(e,"error_parcels",{method:"POST",body:JSON.stringify({transfer_number:r,scanned_by:t.id,scanned_by_name:t.full_name,error_type:"already_scanned",error_message:"Already scanned during loading"})}),e.json({success:!1,error:"Already scanned",transfer_number:r});await f(e,`transfer_details?id=eq.${o.id}`,{method:"PATCH",body:JSON.stringify({is_scanned_loading:!0,scanned_loading_at:new Date().toISOString(),scanned_loading_by:t.id,status:"loaded"})});const i=(await(await f(e,`parcels?id=eq.${o.parcel_id}&select=*`)).json())[0],c=(i.scanned_count||0)+1,d={scanned_count:c};return c===i.total_count&&(d.status="loaded"),await f(e,`parcels?id=eq.${o.parcel_id}`,{method:"PATCH",body:JSON.stringify(d)}),e.json({success:!0,transfer_number:r,outlet_code:o.outlet_code,outlet_code_short:o.outlet_code_short,outlet_name:o.outlet_name,scanned_count:c,total_count:i.total_count})}catch(t){return console.error("Scan error:",t),e.json({error:"Scan failed"},500)}});g.post("/api/warehouse/complete",w,async e=>{try{const t=e.get("user"),{outlet_code:r,signature_name:s}=await e.req.json();return await f(e,`parcels?outlet_code=eq.${r}&status=eq.loaded`,{method:"PATCH",body:JSON.stringify({loaded_at:new Date().toISOString(),loaded_by:t.id,loaded_by_name:s||t.full_name,scanned_loading_by_name:t.full_name})}),e.json({success:!0})}catch{return e.json({error:"Failed to complete loading"},500)}});g.post("/api/warehouse/set-box-container-count",w,async e=>{try{const t=e.get("user"),{outlet_code:r,box_count:s,container_count:n}=await e.req.json();return!r||s===void 0||n===void 0?e.json({error:"Missing required fields: outlet_code, box_count, container_count"},400):(console.log(`Setting box/container count for outlet ${r}: ${s} boxes, ${n} containers`),await f(e,`parcels?outlet_code=eq.${r}&status=eq.loaded`,{method:"PATCH",body:JSON.stringify({box_count:parseInt(s),container_count:parseInt(n)})}),e.json({success:!0,box_count:parseInt(s),container_count:parseInt(n),outlet_code:r}))}catch(t){return console.error("Set box/container count error:",t),e.json({error:"Failed to set box/container count"},500)}});g.post("/api/warehouse/set-container-count",w,async e=>{try{const t=e.get("user"),{outlet_code:r,container_count:s}=await e.req.json();return!r||!s?e.json({error:"Missing required fields"},400):(await f(e,`parcels?outlet_code=eq.${r}&status=eq.loaded`,{method:"PATCH",body:JSON.stringify({container_count_loaded:s})}),e.json({success:!0,container_count:s}))}catch{return e.json({error:"Failed to set container count"},500)}});g.post("/api/warehouse/scan-container",w,async e=>{try{const t=e.get("user"),{container_id:r,outlet_code:s,outlet_name:n,delivery_date:o}=await e.req.json();if(!r||!s||!o)return e.json({error:"Missing required fields: container_id, outlet_code, delivery_date"},400);console.log(`🔍 Scanning A code container: ${r} for outlet ${s}`),console.log("📝 Scan details:",{container_id:r,outlet_code:s,outlet_name:n,delivery_date:o,user:t.full_name});const l=await(await f(e,`container_inventory?container_id=eq.${r}&outlet_code=eq.${s}&select=*`)).json();if(l&&l.length>0)return console.log(`⚠️ Duplicate scan detected: ${r} already exists for outlet ${s}`),e.json({success:!1,error:"Container already scanned for this outlet",container_id:r});console.log("💾 Saving A-code to container_inventory:",{container_id:r,outlet_code:s,outlet_name:n,delivery_date:o,status:"at_outlet"});const c=await(await f(e,"container_inventory",{method:"POST",body:JSON.stringify({container_id:r,outlet_code:s,outlet_name:n||`Outlet ${s}`,delivery_date:o,status:"at_outlet",scanned_at:new Date().toISOString(),scanned_by:t.id,scanned_by_name:t.full_name})})).json();return console.log("✅ A-code saved successfully:",c),e.json({success:!0,container_id:r,outlet_code:s,saved_data:c})}catch(t){return console.error("Scan container error:",t),e.json({error:"Failed to scan container"},500)}});g.get("/api/debug/containers/:outlet_code",w,async e=>{try{const t=e.req.param("outlet_code"),s=await(await f(e,`container_inventory?outlet_code=eq.${t}&select=*`)).json(),o=await(await f(e,"container_inventory?select=*&order=scanned_at.desc&limit=20")).json();return e.json({outlet_code:t,containers_for_outlet:s,recent_containers:o,query_used:`container_inventory?outlet_code=eq.${t}&select=*`})}catch(t){return console.error("Debug containers error:",t),e.json({error:"Failed to query containers"},500)}});g.delete("/api/warehouse/outlet/:outlet_code",w,async e=>{try{const t=e.get("user"),r=e.req.param("outlet_code");return["admin","warehouse_supervisor"].includes(t.role)?(await f(e,`transfer_details?outlet_code=eq.${r}`,{method:"DELETE"}),await f(e,`parcels?outlet_code=eq.${r}`,{method:"DELETE"}),e.json({success:!0,message:`All transfers for outlet ${r} deleted`})):e.json({error:"Only supervisors and admins can delete records"},403)}catch(t){return console.error("Delete outlet transfers error:",t),e.json({error:"Failed to delete outlet transfers"},500)}});g.delete("/api/warehouse/transfer/:transfer_id",w,async e=>{try{const t=e.get("user"),r=e.req.param("transfer_id");if(!["admin","warehouse_supervisor"].includes(t.role))return e.json({error:"Only supervisors and admins can delete records"},403);const n=await(await f(e,`transfer_details?id=eq.${r}&select=*`)).json();if(!n||n.length===0)return e.json({error:"Transfer not found"},404);const a=n[0].parcel_id;await f(e,`transfer_details?id=eq.${r}`,{method:"DELETE"});const i=await(await f(e,`transfer_details?parcel_id=eq.${a}&select=count`)).text();try{const c=JSON.parse(i);if(Array.isArray(c)&&c.length===0)await f(e,`parcels?id=eq.${a}`,{method:"DELETE"});else{const p=await(await f(e,`transfer_details?parcel_id=eq.${a}&select=*`)).json();await f(e,`parcels?id=eq.${a}`,{method:"PATCH",body:JSON.stringify({total_count:p.length,scanned_count:p.filter(h=>h.is_scanned_loading).length})})}}catch{console.log("Could not parse remaining count, continuing...")}return e.json({success:!0,message:"Transfer deleted"})}catch(t){return console.error("Delete transfer error:",t),e.json({error:"Failed to delete transfer"},500)}});g.post("/api/outlet/find-pallets",w,async e=>{try{const t=e.get("user"),{outlet_code_short:r}=await e.req.json();console.log(`Finding pallets for outlet: ${r}`);const n=await(await f(e,`parcels?outlet_code_short=eq.${r}&status=eq.loaded&select=*&order=pallet_id.asc`)).json();if(console.log(`Found ${n.length} loaded parcels`),!n||n.length===0)return e.json({success:!1,error:"No loaded pallets found for this outlet"});const o=n[0],a=o.container_count_loaded||0,l=o.box_count||0,i=o.container_count||0;let c=[];console.log(`🔍 Fetching A-code containers for outlet ${o.outlet_code}, container_count=${i}`),console.log("📝 Full outlet info:",{outlet_code:o.outlet_code,outlet_code_short:o.outlet_code_short,outlet_name:o.outlet_name}),console.log(`📝 Query: container_inventory?outlet_code=eq.${o.outlet_code}&select=*`);try{const p=await(await f(e,`container_inventory?outlet_code=eq.${o.outlet_code}&select=*`)).json();console.log(`✅ Query returned ${(p==null?void 0:p.length)||0} A-code containers`),console.log("📦 Container data:",JSON.stringify(p,null,2)),p&&p.length>0&&(c=p.map(h=>({container_id:h.container_id,scanned_at:h.scanned_at,status:h.status})))}catch(d){console.error("Error fetching A-code containers:",d)}return e.json({success:!0,outlet_code:o.outlet_code,outlet_code_short:o.outlet_code_short,outlet_name:o.outlet_name,container_count_loaded:a,box_count:l,container_count:i,a_code_containers:c,pallets:n.map(d=>({id:d.id,pallet_id:d.pallet_id,transfer_count:d.total_count,status:d.status}))})}catch(t){return console.error("Find pallets error:",t),e.json({error:"Failed to find pallets"},500)}});g.post("/api/outlet/scan-pallet",w,async e=>{try{const t=e.get("user"),{outlet_code_short:r,pallet_id:s}=await e.req.json();console.log(`Scanning pallet ${s} for outlet ${r}`);const o=await(await f(e,`parcels?pallet_id=eq.${s}&outlet_code_short=eq.${r}&select=*`)).json();if(console.log(`Found ${o.length} parcels for this pallet+outlet combination`),!o||o.length===0)return await f(e,"error_parcels",{method:"POST",body:JSON.stringify({transfer_number:s,scanned_by:t.id,scanned_by_name:t.full_name,error_type:"not_found",error_message:`Pallet ID not found for outlet ${r}`,outlet_code:r})}),e.json({success:!1,error:"Pallet not found for your outlet",pallet_id:s});const a=o[0];return a.status==="delivered"?(await f(e,"error_parcels",{method:"POST",body:JSON.stringify({transfer_number:s,scanned_by:t.id,scanned_by_name:t.full_name,error_type:"already_scanned",error_message:`Pallet already delivered at ${a.delivered_at||"earlier"}`,outlet_code:a.outlet_code})}),e.json({success:!1,error:"Duplicate scan! This pallet was already received",pallet_id:s,delivered_at:a.delivered_at})):a.status!=="loaded"?e.json({success:!1,error:a.status==="pending"?"Pallet not yet loaded at warehouse":"Pallet already delivered",pallet_id:s}):e.json({success:!0,pallet_id:s,transfer_count:a.total_count})}catch(t){return console.error("Scan pallet error:",t),e.json({error:"Scan failed"},500)}});g.post("/api/outlet/revert-pallet",w,async e=>{try{const t=e.get("user"),{pallet_id:r,outlet_code_short:s}=await e.req.json();return console.log(`Reverting outlet pallet scan for ${r} at outlet ${s}`),e.json({success:!0,pallet_id:r,message:"Pallet removed from scan list (remains in loaded status)"})}catch(t){return console.error("Revert outlet pallet error:",t),e.json({error:"Revert failed"},500)}});g.post("/api/outlet/scan-container",w,async e=>{try{const t=e.get("user"),{outlet_code_short:r,outlet_code:s,container_id:n}=await e.req.json();console.log(`Scanning container ${n} for outlet ${r||s}`);const a=await(await f(e,`container_inventory?container_id=eq.${n}&outlet_code=eq.${s||r}&select=*`)).json();return!a||a.length===0?e.json({success:!1,error:"Container not found for this outlet",container_id:n}):a[0].status==="delivered"?e.json({success:!1,error:"Duplicate scan! This container was already received",container_id:n}):e.json({success:!0,container_id:n})}catch(t){return console.error("Scan container error:",t),e.json({error:"Scan failed"},500)}});g.post("/api/outlet/confirm-receipt",w,async e=>{try{const t=e.get("user"),{pallet_id:r,outlet_code_short:s,receiver_name:n}=await e.req.json();console.log(`Confirming receipt: ${r} by ${n} for outlet ${s}`);const a=await(await f(e,`parcels?pallet_id=eq.${r}&outlet_code_short=eq.${s}&status=eq.loaded&select=*`)).json();if(!a||a.length===0)return e.json({success:!1,error:"Pallet not found or already delivered"});const l=a[0],c=await(await f(e,`transfer_details?parcel_id=eq.${l.id}&select=*`)).json();for(const d of c)await f(e,`transfer_details?id=eq.${d.id}`,{method:"PATCH",body:JSON.stringify({is_scanned_unloading:!0,scanned_unloading_at:new Date().toISOString(),scanned_unloading_by:t.id,status:"delivered"})});return await f(e,`parcels?id=eq.${l.id}`,{method:"PATCH",body:JSON.stringify({status:"delivered",delivered_at:new Date().toISOString(),delivered_by:t.id,delivered_by_name:t.full_name,received_by_name:n})}),console.log(`✓ Pallet ${r} confirmed as delivered by ${n}`),e.json({success:!0,pallet_id:r,receiver_name:n,transfer_count:l.total_count})}catch(t){return console.error("Confirm receipt error:",t),e.json({error:"Failed to confirm receipt"},500)}});g.post("/api/outlet/confirm-receipt-bulk",w,async e=>{try{const t=e.get("user"),{outlet_code_short:r,pallet_ids:s,receiver_name:n,container_count:o}=await e.req.json();if(console.log(`Bulk confirming receipt for outlet ${r}: ${s.length} pallets in ${o||"unknown"} containers by ${n}`),!s||s.length===0)return e.json({error:"No pallet IDs provided"},400);let a=0,l=0;const i=[];for(const c of s)try{const p=await(await f(e,`parcels?pallet_id=eq.${c}&outlet_code_short=eq.${r}&status=eq.loaded&select=*`)).json();if(!p||p.length===0){l++,i.push(`${c}: not found or already delivered`);continue}const h=p[0],E=await(await f(e,`transfer_details?parcel_id=eq.${h.id}&select=*`)).json();for(const _ of E)await f(e,`transfer_details?id=eq.${_.id}`,{method:"PATCH",body:JSON.stringify({is_scanned_unloading:!0,scanned_unloading_at:new Date().toISOString(),scanned_unloading_by:t.id,status:"delivered"})});if(await f(e,`parcels?id=eq.${h.id}`,{method:"PATCH",body:JSON.stringify({status:"delivered",delivered_at:new Date().toISOString(),delivered_by:t.id,delivered_by_name:t.full_name,received_by_name:n,container_count_delivered:o})}),c.toUpperCase().startsWith("A"))try{console.log(`♻️ Detected recyclable container: ${c} - Adding to inventory at outlet ${r}`),await f(e,"container_inventory",{method:"POST",body:JSON.stringify({container_id:c,outlet_code:h.outlet_code,outlet_name:h.outlet_name,status:"at_outlet",delivered_at:new Date().toISOString(),delivered_by:t.id,delivered_by_name:t.full_name,delivery_date:h.delivery_date,original_outlet_code:h.outlet_code,original_outlet_name:h.outlet_name})}),console.log(`✓ Container ${c} added to inventory at ${r}`)}catch(_){console.error(`⚠️ Failed to add container ${c} to inventory:`,_)}a++,console.log(`✓ Pallet ${c} confirmed as delivered`)}catch(d){l++,i.push(`${c}: ${d instanceof Error?d.message:"unknown error"}`),console.error(`Error confirming pallet ${c}:`,d)}return console.log(`Bulk confirmation complete: ${a} success, ${l} errors`),e.json({success:!0,total:s.length,success_count:a,error_count:l,errors:i.length>0?i:void 0,receiver_name:n})}catch(t){return console.error("Bulk confirm receipt error:",t),e.json({error:"Failed to confirm receipts"},500)}});g.get("/api/outlet/parcels/:outlet_code",w,async e=>{try{const t=e.get("user");let r=e.req.param("outlet_code");t.role==="outlet"&&t.outlet_code&&(r=t.outlet_code);const n=await(await f(e,`parcels?outlet_code=eq.${r}&status=eq.loaded&select=*`)).json();return e.json({parcels:n})}catch{return e.json({error:"Failed to fetch parcels"},500)}});g.get("/api/outlet/transfers/:outlet_code",w,async e=>{try{const t=e.get("user");let r=e.req.param("outlet_code");t.role==="outlet"&&t.outlet_code&&(r=t.outlet_code);const n=await(await f(e,`transfer_details?outlet_code=eq.${r}&status=eq.loaded&select=*`)).json();return e.json({transfers:n})}catch{return e.json({error:"Failed to fetch transfers"},500)}});g.post("/api/outlet/scan",w,async e=>{try{const t=e.get("user"),{transfer_number:r,outlet_code:s}=await e.req.json(),o=await(await f(e,`transfer_details?transfer_number=eq.${r}&status=eq.loaded&select=*`)).json();if(!o||o.length===0)return await f(e,"error_parcels",{method:"POST",body:JSON.stringify({transfer_number:r,scanned_by:t.id,scanned_by_name:t.full_name,error_type:"not_found",error_message:"Transfer number not found or not loaded",outlet_code:s})}),e.json({success:!1,error:"Transfer number not found or not loaded",transfer_number:r});const a=o[0];return a.outlet_code!==s?(await f(e,"error_parcels",{method:"POST",body:JSON.stringify({transfer_number:r,scanned_by:t.id,scanned_by_name:t.full_name,error_type:"wrong_outlet",error_message:`This parcel belongs to ${a.outlet_code}`,outlet_code:s})}),e.json({success:!1,error:`Wrong outlet! This belongs to ${a.outlet_code}`,transfer_number:r})):(await f(e,`transfer_details?id=eq.${a.id}`,{method:"PATCH",body:JSON.stringify({is_scanned_unloading:!0,scanned_unloading_at:new Date().toISOString(),scanned_unloading_by:t.id,status:"delivered"})}),(await(await f(e,`transfer_details?parcel_id=eq.${a.parcel_id}&select=*`)).json()).every(d=>d.status==="delivered")&&await f(e,`parcels?id=eq.${a.parcel_id}`,{method:"PATCH",body:JSON.stringify({status:"delivered"})}),e.json({success:!0,transfer_number:r,outlet_code:a.outlet_code}))}catch(t){return console.error("Scan error:",t),e.json({error:"Scan failed"},500)}});g.post("/api/outlet/complete",w,async e=>{try{const t=e.get("user"),{outlet_code:r,signature_name:s}=await e.req.json();return await f(e,`parcels?outlet_code=eq.${r}&status=eq.delivered`,{method:"PATCH",body:JSON.stringify({delivered_at:new Date().toISOString(),delivered_by:t.id,scanned_unloading_by_name:t.full_name,received_by_name:s})}),e.json({success:!0})}catch{return e.json({error:"Failed to complete unloading"},500)}});g.get("/api/outlets",w,async e=>{try{const t=await f(e,"outlets?select=*&order=outlet_code.asc");if(!t.ok){const s=await t.text();return console.error("Supabase error:",s),e.json({error:"Failed to fetch outlets",details:s},500)}const r=await t.json();return console.log("Outlets fetched (v1.0.4):",Array.isArray(r)?r.length:"not an array"),e.json({outlets:Array.isArray(r)?r:[]})}catch(t){return console.error("Failed to fetch outlets exception:",t),e.json({error:"Failed to fetch outlets",message:String(t)},500)}});g.get("/api/v2/outlets",w,async e=>{try{const t=await f(e,"outlets?select=*&order=outlet_code.asc");if(!t.ok){const s=await t.text();return e.json({error:"Failed to fetch outlets",details:s},500)}const r=await t.json();return e.json({outlets:Array.isArray(r)?r:[],version:"1.0.4"})}catch(t){return e.json({error:"Failed to fetch outlets",message:String(t)},500)}});g.get("/api/parcels",w,async e=>{try{const r=await(await f(e,"parcels?select=outlet_code,outlet_code_short,outlet_name&order=outlet_code.asc")).json();return e.json({parcels:r})}catch(t){return console.error("Failed to fetch parcels:",t),e.json({error:"Failed to fetch parcels"},500)}});g.get("/api/containers/by-outlet/:outlet_code",w,async e=>{try{const t=e.get("user");let r=e.req.param("outlet_code");t.role==="outlet"&&t.outlet_code&&(r=t.outlet_code);const n=await(await f(e,`container_inventory?outlet_code=eq.${r}&status=eq.at_outlet&select=*&order=delivered_at.desc`)).json();return e.json({containers:n})}catch(t){return console.error("Failed to fetch containers:",t),e.json({error:"Failed to fetch containers"},500)}});g.get("/api/containers/inventory",w,async e=>{try{const t=e.get("user");if(!["admin","warehouse","warehouse_staff","warehouse_supervisor","outlet","driver"].includes(t.role))return e.json({error:"Forbidden"},403);let r="container_inventory?select=*&order=delivered_at.desc";t.role==="outlet"&&t.outlet_code&&(r=`container_inventory?outlet_code=eq.${t.outlet_code}&select=*&order=delivered_at.desc`);const n=await(await f(e,r)).json();return e.json({containers:n})}catch(t){return console.error("Failed to fetch container inventory:",t),e.json({error:"Failed to fetch container inventory"},500)}});g.post("/api/containers/scan-collect",w,async e=>{try{const t=e.get("user"),{container_id:r,outlet_code:s}=await e.req.json();console.log(`🔍 Scanning container ${r} for collection at outlet ${s}`);const o=await(await f(e,`container_inventory?container_id=eq.${r}&status=eq.at_outlet&select=*`)).json();if(!o||o.length===0)return console.log(`❌ Container ${r} not found in inventory`),e.json({success:!1,error:"Container not found or already collected",container_id:r});const a=o[0];return a.outlet_code!==s?(console.log(`⚠️ Container ${r} belongs to ${a.outlet_code}, not ${s}`),e.json({success:!1,cross_outlet:!0,error:`This container belongs to ${a.outlet_name} (${a.outlet_code})`,container_id:r,current_outlet:a.outlet_code,current_outlet_name:a.outlet_name,scanning_outlet:s})):(console.log(`✓ Container ${r} validated for collection`),e.json({success:!0,container_id:r,outlet_code:a.outlet_code,outlet_name:a.outlet_name,delivered_at:a.delivered_at}))}catch(t){return console.error("Container scan error:",t),e.json({error:"Scan failed"},500)}});g.post("/api/containers/collect-cross-outlet",w,async e=>{try{const t=e.get("user"),{container_id:r,scanning_outlet:s}=await e.req.json();console.log(`♻️ Cross-outlet collection: Container ${r} from ${s} by ${t.full_name}`);const o=await(await f(e,`container_inventory?container_id=eq.${r}&status=eq.at_outlet&select=*`)).json();if(!o||o.length===0)return e.json({success:!1,error:"Container not found or already collected",container_id:r});const a=o[0];return await f(e,`container_inventory?id=eq.${a.id}`,{method:"PATCH",body:JSON.stringify({status:"collected",collected_at:new Date().toISOString(),collected_by:t.id,collected_by_name:t.full_name})}),console.log(`✓ Container ${r} collected from ${a.outlet_code} (cross-outlet)`),e.json({success:!0,container_id:r,original_outlet:a.outlet_code,original_outlet_name:a.outlet_name,scanning_outlet:s})}catch(t){return console.error("Cross-outlet collection error:",t),e.json({error:"Collection failed"},500)}});g.post("/api/containers/complete-collection",w,async e=>{try{const t=e.get("user"),{outlet_code:r,container_ids:s,signature_name:n}=await e.req.json();if(console.log(`📦 Completing collection for outlet ${r}: ${s.length} containers by ${n}`),!s||s.length===0)return e.json({error:"No container IDs provided"},400);let o=0,a=0;const l=[];for(const i of s)try{const d=await(await f(e,`container_inventory?container_id=eq.${i}&outlet_code=eq.${r}&status=eq.at_outlet&select=*`)).json();if(!d||d.length===0){a++,l.push(`${i}: not found or already collected`);continue}const p=d[0];await f(e,`container_inventory?id=eq.${p.id}`,{method:"PATCH",body:JSON.stringify({status:"collected",collected_at:new Date().toISOString(),collected_by:t.id,collected_by_name:t.full_name,collection_signature:n})}),o++,console.log(`✓ Container ${i} collected from ${r}`)}catch(c){a++,l.push(`${i}: ${c instanceof Error?c.message:"unknown error"}`),console.error(`Error collecting container ${i}:`,c)}return console.log(`Collection complete: ${o} success, ${a} errors`),e.json({success:!0,total:s.length,success_count:o,error_count:a,errors:l.length>0?l:void 0,signature_name:n})}catch(t){return console.error("Complete collection error:",t),e.json({error:"Failed to complete collection"},500)}});g.get("/api/reports/deliveries",w,async e=>{try{const t=e.get("user"),{start_date:r,end_date:s,outlet_code:n}=e.req.query();let o="parcels?select=*&order=delivered_at.desc";t.role==="outlet"&&t.outlet_code?o+=`&outlet_code=eq.${t.outlet_code}`:n&&(o+=`&outlet_code=eq.${n}`),r&&(o+=`&delivered_at=gte.${r}`),s&&(o+=`&delivered_at=lte.${s}`);const l=await(await f(e,o)).json();return e.json({deliveries:l})}catch{return e.json({error:"Failed to fetch reports"},500)}});g.get("/api/reports/errors",w,async e=>{try{const t=e.get("user");let r="error_parcels?select=*&order=created_at.desc";t.role==="outlet"&&t.outlet_code&&(r+=`&outlet_code=eq.${t.outlet_code}`);const n=await(await f(e,r)).json();return e.json({errors:n})}catch{return e.json({error:"Failed to fetch errors"},500)}});g.get("/api/reports/audit",w,async e=>{try{const r=await(await f(e,"audit_logs?select=*&order=created_at.desc&limit=100")).json();return e.json({logs:r})}catch{return e.json({error:"Failed to fetch audit logs"},500)}});g.get("/",e=>e.html(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APD OASIS - Warehouse Logistic System</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .scan-input {
            border: 3px solid #3b82f6;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { border-color: #3b82f6; }
            50% { border-color: #60a5fa; }
        }
        .success-flash {
            animation: successFlash 0.5s;
        }
        @keyframes successFlash {
            0%, 100% { background-color: transparent; }
            50% { background-color: #10b981; }
        }
        .error-flash {
            animation: errorFlash 0.5s;
        }
        @keyframes errorFlash {
            0%, 100% { background-color: transparent; }
            50% { background-color: #ef4444; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"><\/script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"><\/script>
    <script src="/static/app.js"><\/script>
</body>
</html>
  `));const Xe=new Et,Qr=Object.assign({"/src/index.tsx":g});let Nt=!1;for(const[,e]of Object.entries(Qr))e&&(Xe.all("*",t=>{let r;try{r=t.executionCtx}catch{}return e.fetch(t.req.raw,t.env,r)}),Xe.notFound(t=>{let r;try{r=t.executionCtx}catch{}return e.fetch(t.req.raw,t.env,r)}),Nt=!0);if(!Nt)throw new Error("Can't import modules from ['/src/index.ts','/src/index.tsx','/app/server.ts']");export{Xe as default};
